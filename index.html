// ===================== Enhanced MiStats (comprehensive tracking) =====================
(function(){
  const STORE_KEY = 'mistats_comprehensive_v1';

  // unit helpers
  const kgFrom = (val, unit) => {
    const n = parseFloat(val); if (isNaN(n)) return null;
    if (unit==='kg') return n;
    if (unit==='lb') return n * 0.45359237;
    if (unit==='st') return n * 6.35029318;
    return n;
  };
  const toUnit = (kg, unit) => {
    if (kg==null) return '';
    if (unit==='kg') return kg.toFixed(1);
    if (unit==='lb') return (kg/0.45359237).toFixed(1);
    if (unit==='st') return (kg/6.35029318).toFixed(2);
    return kg.toFixed(1);
  };
  const cmFromHeightInput = (val, unit) => {
    if (unit==='ftin'){
      const m = String(val).trim().match(/(\d+)[^\d]+(\d+)/);
      if (m){ const ft=+m[1], inch=+m[2]; return Math.round((ft*12+inch)*2.54); }
      const n=parseFloat(val); if(!isNaN(n)) return Math.round(n*12*2.54);
      return null;
    }
    const n = parseFloat(val); if (isNaN(n)) return null;
    if (unit==='m') return Math.round(n*100);
    return Math.round(n); // cm
  };
  const bmi = (kg, cm) => (kg>0 && cm>0) ? +(kg/((cm/100)**2)).toFixed(1) : null;

  // store
  function loadStore(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'{}'); }catch(e){ return {}; } }
  function saveStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
  function activeId(){ return getProfilesAndActive().activeId; }
  function ensureProfileBucket(){
    const id = activeId(); const s = loadStore();
    if(!s[id]) s[id] = { 
      unitW:'kg', unitH:'cm', heightCm:null, targetKg:null, 
      weightEntries:[], measurementEntries:[]
    };
    return s;
  }
  function getBucket(){ const s=ensureProfileBucket(); return { s, b: s[activeId()] }; }

  // Tabs
  function setMiTab(view){
    document.querySelectorAll('#mi_tabs .mi-tab').forEach(b=>{
      b.classList.toggle('active', b.dataset.view===view);
    });
    document.querySelectorAll('#mistats .mi-view').forEach(v=> v.style.display='none');
    $('#mi_view_'+view).style.display='block';
    if(view==='graph') miDrawGraph();
    if(view==='history') miRenderHistory();
  }
  window.setMiTab = setMiTab;

  // Click handlers
  document.addEventListener('click', (e)=>{
    const t=e.target.closest('.mi-tab'); if(t){ setMiTab(t.dataset.view); return; }
    const gt=e.target.closest('.mi-graph-type'); if(gt){
      document.querySelectorAll('.mi-graph-type').forEach(b=>b.classList.remove('active'));
      gt.classList.add('active'); miDrawGraph(); return;
    }
    const hf=e.target.closest('.mi-hist-filter'); if(hf){
      document.querySelectorAll('.mi-hist-filter').forEach(b=>b.classList.remove('active'));
      hf.classList.add('active'); miRenderHistory(); return;
    }
    const uw=e.target.closest('.mi-unit-w'); if(uw){ 
      const {s,b}=getBucket(); b.unitW=uw.dataset.u; saveStore(s); refreshAll(); return;
    }
    const uh=e.target.closest('.mi-unit-h'); if(uh){ 
      const {s,b}=getBucket(); b.unitH=uh.dataset.u; saveStore(s); refreshAll(); return;
    }
  });

  // Add entries
  function onAddWeight(){
    const {s,b}=getBucket();
    const unit=b.unitW||'kg';
    const kg = kgFrom($('#mi_weight_in').value, unit);
    const d = $('#mi_date_in').value || new Date().toISOString().slice(0,10);
    if(kg==null){ alert('Enter a valid weight'); return; }
    b.weightEntries.push({d, kg:+kg.toFixed(2), type:'weight'});
    b.weightEntries.sort((a,b)=> a.d.localeCompare(b.d));
    saveStore(s);
    $('#mi_weight_in').value=''; $('#mi_date_in').value='';
    refreshAll();
  }
  
  function onAddMeasurements(){
    const {s,b}=getBucket();
    const d = $('#mi_date_in').value || new Date().toISOString().slice(0,10);
    const bust = fromDisplay($('#mi_bust_in').value);
    const waist = fromDisplay($('#mi_waist_in').value);
    const hip = fromDisplay($('#mi_hip_in').value);
    
    if(!bust && !waist && !hip){ alert('Enter at least one measurement'); return; }
    
    const entry = {d, type:'measurements'};
    if(bust) entry.bust = bust;
    if(waist) entry.waist = waist;
    if(hip) entry.hip = hip;
    
    b.measurementEntries.push(entry);
    b.measurementEntries.sort((a,b)=> a.d.localeCompare(b.d));
    saveStore(s);
    
    $('#mi_bust_in').value=''; $('#mi_waist_in').value=''; $('#mi_hip_in').value='';
    $('#mi_date_in').value='';
    refreshAll();
  }

  $('#mi_add_weight_btn')?.addEventListener('click', onAddWeight);
  $('#mi_add_measurements_btn')?.addEventListener('click', onAddMeasurements);

  // Settings in main settings tab
  $('#save_global_settings')?.addEventListener('click', ()=>{
    const {s,b}=getBucket();
    const h = cmFromHeightInput($('#settings_height').value, b.unitH||'cm');
    if(h) b.heightCm=h;
    const tgtRaw = $('#settings_target').value.trim();
    b.targetKg = tgtRaw ? kgFrom(tgtRaw, b.unitW||'kg') : null;
    saveStore(s); refreshAll(); alert('Settings saved!');
  });
  
  $('#reset_current_profile')?.addEventListener('click', ()=>{
    if(!confirm('Reset MiStats for this profile? This will delete all weight and measurement data.')) return;
    const s=loadStore(); delete s[activeId()]; saveStore(s); refreshAll();
  });

  // Zoom
  $('#mi_zoom')?.addEventListener('input', miDrawGraph);

  // Calculations
  function calcWeightStats(){
    const {b}=getBucket(); const E=b.weightEntries || [];
    const heightCm = b.heightCm ?? getProfilesAndActive().profiles.find(p=>p.id===activeId())?.height ?? null;
    
    if(E.length===0) return { empty:true, unitW:b.unitW, heightCm, targetKg:b.targetKg };
    
    const start=E[0], curr=E[E.length-1], target=b.targetKg ?? null;
    const lost = start.kg - curr.kg;
    const remaining = target ? curr.kg - target : null;
    
    let progress = 0;
    if(target && start.kg !== target) {
      const totalLoss = start.kg - target;
      progress = Math.min(100, Math.max(0, (lost / totalLoss) * 100));
    }

    return { unitW:b.unitW, heightCm, targetKg:target, start, curr, lost, remaining, progress };
  }
  
  function calcMeasurementStats(){
    const {b}=getBucket(); const E=b.measurementEntries || [];
    if(E.length===0) return { empty:true };
    
    const start = E[0], curr = E[E.length-1];
    const changes = {};
    
    ['bust', 'waist', 'hip'].forEach(measure => {
      if(start[measure] && curr[measure]) {
        changes[measure] = {
          start: start[measure],
          current: curr[measure],
          change: start[measure] - curr[measure]
        };
      }
    });
    
    return { start, curr, changes };
  }

  // Renderers
  function renderCurrent(){
    const {unitW}=getBucket().b; 
    const weightStats = calcWeightStats();
    const measurementStats = calcMeasurementStats();
    
    const unitLabel = unitW==='kg'?'kg':(unitW==='lb'?'lb':'st');
    $('#mi_hint_units').textContent = `Weight unit: ${unitLabel} • Measurements: ${UNIT_MODE}`;

    // Weight progress
    if(weightStats.empty) {
      $('#mi_start_weight').textContent = '—';
      $('#mi_current_weight').textContent = '—';
      $('#mi_weight_lost').textContent = '—';
      $('#mi_start_bmi').textContent = 'BMI —';
      $('#mi_current_bmi').textContent = 'BMI —';
      $('#mi_weight_remaining').textContent = 'Add weight entries';
      $('#mi_weight_prog_bar').style.width = '0%';
      $('#mi_weight_prog_text').textContent = 'No weight data yet';
    } else {
      $('#mi_start_weight').textContent = `${toUnit(weightStats.start.kg, unitW)} ${unitLabel}`;
      $('#mi_current_weight').textContent = `${toUnit(weightStats.curr.kg, unitW)} ${unitLabel}`;
      $('#mi_weight_lost').textContent = `${toUnit(Math.abs(weightStats.lost), unitW)} ${unitLabel}`;
      
      const startBMI = bmi(weightStats.start.kg, weightStats.heightCm);
      const currBMI = bmi(weightStats.curr.kg, weightStats.heightCm);
      $('#mi_start_bmi').textContent = startBMI ? `BMI ${startBMI}` : 'BMI —';
      $('#mi_current_bmi').textContent = currBMI ? `BMI ${currBMI}` : 'BMI —';
      
      $('#mi_weight_remaining').textContent = weightStats.remaining !== null ? 
        `${toUnit(Math.abs(weightStats.remaining), unitW)} ${unitLabel} to target` : 'No target set';
      
      $('#mi_weight_prog_bar').style.width = `${weightStats.progress.toFixed(0)}%`;
      $('#mi_weight_prog_text').textContent = 
        `Progress: ${weightStats.progress.toFixed(1)}% ${weightStats.targetKg ? 'to target' : ''}`;
    }

    // Measurements progress
    const measWrap = $('#mi_measurements_progress');
    if(measurementStats.empty) {
      measWrap.innerHTML = '<div class="note">Add measurement entries to see progress tracking.</div>';
    } else {
      let html = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">';
      
      ['bust', 'waist', 'hip'].forEach(measure => {
        if(measurementStats.changes[measure]) {
          const c = measurementStats.changes[measure];
          const changeText = c.change > 0 ? `-${toDisplay(c.change)}` : `+${toDisplay(Math.abs(c.change))}`;
          const changeClass = c.change > 0 ? 'success' : 'danger';
          
          html += `
            <div class="mi-tile">
              <div class="mi-l">${measure.charAt(0).toUpperCase() + measure.slice(1)}</div>
              <div class="mi-v">${toDisplay(c.current)} ${UNIT_MODE}</div>
              <div class="mi-sub ${changeClass}">${changeText} ${UNIT_MODE}</div>
            </div>
          `;
        }
      });
      
      html += '</div>';
      measWrap.innerHTML = html;
    }
  }

  function miRenderHistory(){
    const wrap = $('#mi_hist_list'); wrap.innerHTML='';
    const {b}=getBucket(); const U=b.unitW||'kg';
    const filter = document.querySelector('.mi-hist-filter.active')?.dataset.filter || 'all';
    
    let allEntries = [];
    
    if(filter === 'all' || filter === 'weight') {
      allEntries = allEntries.concat((b.weightEntries || []).map(e => ({...e, type:'weight'})));
    }
    if(filter === 'all' || filter === 'measurements') {
      allEntries = allEntries.concat((b.measurementEntries || []).map(e => ({...e, type:'measurements'})));
    }
    
    allEntries.sort((a,b) => b.d.localeCompare(a.d)); // newest first
    
    if(allEntries.length===0){ 
      wrap.innerHTML='<div class="note">No entries yet.</div>'; 
      return; 
    }
    
    allEntries.forEach(entry => {
      const row=document.createElement('div'); row.className='mi-row';
      
      if(entry.type === 'weight') {
        row.innerHTML = `
          <div><strong>Weight: ${toUnit(entry.kg,U)} ${U}</strong><div class="note">${new Date(entry.d).toLocaleDateString()}</div></div>
          <div class="note">Weight entry</div>
        `;
      } else if(entry.type === 'measurements') {
        const measurements = [];
        if(entry.bust) measurements.push(`Bust: ${toDisplay(entry.bust)}${UNIT_MODE}`);
        if(entry.waist) measurements.push(`Waist: ${toDisplay(entry.waist)}${UNIT_MODE}`);
        if(entry.hip) measurements.push(`Hip: ${toDisplay(entry.hip)}${UNIT_MODE}`);
        
        row.innerHTML = `
          <div><strong>${measurements.join(', ')}</strong><div class="note">${new Date(entry.d).toLocaleDateString()}</div></div>
          <div class="note">Measurements</div>
        `;
      }
      
      wrap.appendChild(row);
    });
  }

  function miDrawGraph(){
    const {b}=getBucket();
    const c=$('#mi_canvas'); const ctx=c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    
    const graphType = document.querySelector('.mi-graph-type.active')?.dataset.type || 'weight';
    
    if(graphType === 'weight') {
      drawWeightGraph(ctx, c, b);
    } else if(graphType === 'measurements') {
      drawMeasurementsGraph(ctx, c, b);
    } else if(graphType === 'combined') {
      drawCombinedGraph(ctx, c, b);
    }
  }
  
  function drawWeightGraph(ctx, c, b) {
    const E = b.weightEntries || [];
    const U = b.unitW || 'kg';
    
    if(E.length < 1){ 
      $('#mi_graph_note').textContent='Add weight entries to see the chart.'; 
      return; 
    }

    const z = +($('#mi_zoom').value||0);
    $('#mi_zoom_label').textContent = z===0 ? 'All time' : `Zoom ${z}%`;
    const keep = Math.max(5, Math.round(E.length - (E.length-10)*(z/100)));
    const data = E.slice(-keep);

    const weights = data.map(x => x.kg);
    const minW = Math.min(...weights);
    const maxW = Math.max(...weights);
    const pad = Math.max(1, (maxW-minW)*0.1);
    
    drawChart(ctx, c, data, minW-pad, maxW+pad, (pt) => pt.kg, '#5da8ff', U);
    $('#mi_graph_note').textContent = `${data.length} weight points • unit: ${U}`;
  }
  
  function drawMeasurementsGraph(ctx, c, b) {
    const E = b.measurementEntries || [];
    
    if(E.length < 1){ 
      $('#mi_graph_note').textContent='Add measurement entries to see the chart.'; 
      return; 
    }

    const z = +($('#mi_zoom').value||0);
    const keep = Math.max(5, Math.round(E.length - (E.length-10)*(z/100)));
    const data = E.slice(-keep);
    
    // Draw multiple lines for different measurements
    const colors = {bust: '#ff6b9d', waist: '#4ecdc4', hip: '#45b7d1'};
    const measurements = ['bust', 'waist', 'hip'];
    
    let allValues = [];
    measurements.forEach(measure => {
      data.forEach(entry => {
        if(entry[measure]) allValues.push(entry[measure]);
      });
    });
    
    if(allValues.length === 0) {
      $('#mi_graph_note').textContent='No measurement data to display.';
      return;
    }
    
    const minV = Math.min(...allValues);
    const maxV = Math.max(...allValues);
    const pad = Math.max(1, (maxV-minV)*0.1);
    
    // Draw grid and axes first
    drawChartBase(ctx, c, minV-pad, maxV+pad, UNIT_MODE);
    
    // Draw each measurement line
    measurements.forEach(measure => {
      const measureData = data.filter(entry => entry[measure] !== undefined);
      if(measureData.length > 0) {
        drawLine(ctx, c, measureData, minV-pad, maxV+pad, (pt) => pt[measure], colors[measure]);
      }
    });
    
    $('#mi_graph_note').textContent = `${data.length} measurement points • unit: ${UNIT_MODE}`;
  }
  
  function drawCombinedGraph(ctx, c, b) {
    // This would show both weight and measurements on the same timeline
    $('#mi_graph_note').textContent = 'Combined view - feature coming soon';
  }
  
  function drawChart(ctx, c, data, minY, maxY, valueFunc, color, unit)  <div class="bottom-tabs" role="tablist" aria-label="Main tabs">
    <button id="tab_home" class="tab active" onclick="switchTab('home')" role="tab" aria-selected="true">Home</button>
    <button id="tab_back" class="tab" onclick="goBack()" role="tab" style="display:none;">◀ Back</button>
    <button id="tab_mistats" class="tab" onclick="switchTab('mistats')" role="tab">MiStats</button>
    <button id="tab_settings" class="tab" onclick="switchTab('settings')" role="tab">Settings</button>
  </div>
