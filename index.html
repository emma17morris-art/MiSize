<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MiSize - Size Finder & Body Tracker!</title>
  <style>
    :root{
      --brand:#8A2BE2;--bg:#2b1055;--card:#111520;--border:#1b2230;
      --text:#eef1f5;--muted:#aab3c5;--blue:#1d4ed8;--green:#10b981;--orange:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
    .topbar{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(15,19,26,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:8px 16px}
    .topbar-inner{display:flex;gap:12px;align-items:center;max-width:1200px;margin:0 auto}
    .logo{font-size:18px;font-weight:900;color:#cfe0ff;margin-right:8px}
    .pill-group{display:flex;gap:6px;align-items:center}
    .pill{border:1px solid rgba(255,255,255,.12);background:#151a3a;color:#c9d3ea;font-weight:700;font-size:11px;padding:6px 10px;border-radius:999px;cursor:pointer;transition:.2s}
    .pill.active{background:var(--blue);color:#fff;border-color:var(--blue)}
    .spacer{flex:1}

    .screen{display:none;padding-top:80px;padding-bottom:80px;height:100vh;overflow-y:auto}
    .screen.active{display:block}
    .main-container{padding-top:80px;padding-bottom:80px;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
    .title{font-size:48px;font-weight:900;margin:0 0 12px}
    .subtitle{font-size:18px;color:var(--muted);margin:0}

    .region-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;width:100%;max-width:600px;padding:0 20px}
    @media(min-width:1024px){.region-grid{grid-template-columns:repeat(4,1fr);max-width:900px}}
    .region-tile{background:var(--blue);border-radius:16px;padding:32px 20px;cursor:pointer;transition:.3s cubic-bezier(.4,0,.2,1);border:2px solid transparent;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:140px}
    .region-tile:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(29,78,216,.3);border-color:rgba(255,255,255,.2)}
    .region-flag{font-size:40px;margin-bottom:12px}
    .region-name{font-size:20px;font-weight:800;color:#fff;margin:0}

    .hub-container{padding:40px 20px;max-width:800px;margin:0 auto}
    .hub-header{text-align:center;margin-bottom:32px}
    .hub-title{font-size:36px;font-weight:900;margin:0 0 8px}
    .hub-subtitle{font-size:16px;color:var(--muted);margin:0}
    .hub-tiles,.hub-tiles-5{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
    .hub-tiles-5 .hub-tile:last-child{grid-column:span 2}
    .hub-tile{background:var(--blue);border-radius:16px;padding:28px 20px;cursor:pointer;transition:.3s;border:2px solid transparent;text-align:center;color:#fff;font-size:18px;font-weight:800;min-height:110px;display:flex;align-items:center;justify-content:center}
    .hub-tile:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(29,78,216,.3);border-color:rgba(255,255,255,.2)}

    .content-container{max-width:800px;margin:0 auto;padding:20px}
    .form-container{max-width:600px;margin:0 auto;padding:20px}
    .form-group{margin-bottom:18px}
    .form-label{display:block;margin-bottom:8px;font-weight:700}
    .form-select,.form-input{width:100%;padding:12px 16px;background:var(--card);border:2px solid var(--border);border-radius:12px;color:var(--text);font-size:16px;font-weight:600}

    .btn{padding:14px 20px;border:0;border-radius:12px;font-weight:700;font-size:16px;cursor:pointer;transition:.3s}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-secondary{background:var(--card);color:var(--text);border:2px solid var(--border)}
    .btn:hover{transform:translateY(-2px)}

    .brand-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px}
    .brand-card{background:var(--card);border-radius:12px;padding:16px;border:2px solid var(--border)}
    .brand-name{font-size:18px;font-weight:800;margin-bottom:8px}
    .brand-size{background:var(--brand);color:#fff;padding:6px 10px;border-radius:8px;font-size:14px;font-weight:700;display:inline-block;margin-bottom:8px}
    .confidence-indicator{background:var(--green);color:#fff;padding:2px 6px;border-radius:4px;font-size:12px;font-weight:600;margin-left:8px}

    .system-status{background:var(--card);border-radius:12px;padding:16px;margin:16px 0;border:2px solid var(--border)}
    .status-indicator{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .status-online{background:var(--green)} .status-loading{background:var(--orange)} .status-offline{background:var(--muted)}

    .history-list{background:var(--card);border-radius:12px;overflow:hidden;border:2px solid var(--border)}
    .history-item{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .history-item:last-child{border-bottom:none}
    .history-date{font-size:12px;color:var(--muted)}

    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(15,19,26,.9);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:100}
    .nav-item{flex:1;padding:14px 10px;background:transparent;color:#cfd7ea;font-weight:700;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .nav-item.active,.nav-item:hover{color:var(--brand)}

    /* Debug panel */
    .debug-panel{position:fixed;top:60px;right:0;background:var(--card);border:2px solid var(--orange);border-radius:8px 0 0 8px;padding:12px;max-width:300px;font-size:11px;z-index:999;transform:translateX(280px);transition:transform .3s}
    .debug-panel.open{transform:translateX(0)}
    .debug-tab{position:absolute;left:-30px;top:50%;background:var(--orange);color:#fff;padding:8px 6px;border-radius:6px 0 0 6px;cursor:pointer;writing-mode:vertical-rl;font-weight:bold;font-size:10px}
    .loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:var(--brand);animation:spin 1s ease-in-out infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

  <body>
  <!-- Debug Panel -->
  <div id="debug-panel" class="debug-panel">
    <div class="debug-tab" onclick="toggleDebugPanel()">DEBUG</div>
    <div id="debug-content" style="color:var(--text);line-height:1.4;">
      <div style="color:var(--orange);font-weight:bold;margin-bottom:8px;">üîß System Status</div>
      <div id="debug-info">Loading...</div>
      <button onclick="refreshDebug()" class="btn btn-primary" style="font-size:12px;margin-top:8px;padding:8px 10px;">Refresh</button>
    </div>
  </div>

  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="logo">MiSize</div>
      <div class="pill-group" id="bodytype-pills">
        <button class="pill active" data-type="standard">Std</button>
        <button class="pill" data-type="petite">Petite</button>
        <button class="pill" data-type="tall">Tall</button>
        <button class="pill" data-type="plus">Plus</button>
      </div>
      <div class="spacer"></div>
      <div class="pill-group" id="unit-pills">
        <button class="pill active" data-unit="cm">cm</button>
        <button class="pill" data-unit="inch">inch</button>
      </div>
    </div>
  </div>

  <!-- Home -->
  <div id="home" class="screen active">
    <div class="main-container">
      <div class="header">
        <h1 class="title">Welcome to MiSize</h1>
        <p class="subtitle">Your personal size finder and body tracker with AI-powered sizing!</p>
      </div>
      <div class="system-status">
        <div class="status-indicator">
          <div class="status-dot status-loading" id="system-status-dot"></div>
          <span id="system-status-text">Initializing intelligent sizing system...</span>
        </div>
      </div>
      <div class="region-grid">
        <div class="region-tile" onclick="enterHub('UK')"><span class="region-flag">üá¨üáß</span><h3 class="region-name">UK</h3></div>
        <div class="region-tile" onclick="enterHub('EU')"><span class="region-flag">üá™üá∫</span><h3 class="region-name">EU</h3></div>
        <div class="region-tile" onclick="enterHub('US')"><span class="region-flag">üá∫üá∏</span><h3 class="region-name">US</h3></div>
        <div class="region-tile" onclick="enterHub('CA')"><span class="region-flag">üá®üá¶</span><h3 class="region-name">CA</h3></div>
      </div>
    </div>
  </div>

  <!-- Help -->
  <div id="help" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">Help & Support</h2>
        <p class="hub-subtitle">Get started and find answers</p>
      </div>
      <div class="brand-card">
        <h3 style="margin:0 0 8px;color:var(--brand)">üì± How to Use MiSize</h3>
        <p style="margin:0 0 6px">1) Pick region ‚Ä¢ 2) Set profile in Settings ‚Ä¢ 3) Use AI Size Finder.</p>
        <p style="margin:0;color:var(--muted)">AI compares your measurements with brand charts to recommend sizes.</p>
      </div>
      <div class="hub-tiles" style="margin-top:16px">
        <div class="hub-tile" onclick="reportIssue()">üêõ Report Issue</div>
        <div class="hub-tile" onclick="toggleGuide('app-guide')">üìñ App Guide</div>
      </div>
      <div id="app-guide" class="brand-card" style="display:none;margin-top:16px">
        <h4 style="margin:0 0 8px;color:var(--brand)">Complete Guide</h4>
        <p style="margin:0;color:var(--muted)">Body type & units at the top, then UK Hub ‚Üí Size Finder.</p>
      </div>
    </div>
  </div>

  <!-- UK Hub -->
  <div id="uk-hub" class="screen">
    <div class="hub-container">
      <div class="hub-header">
        <div style="font-size:60px;margin-bottom:8px">üá¨üáß</div>
        <h2 class="hub-title">UK Hub</h2>
        <p class="hub-subtitle">United Kingdom sizing & tracking with AI precision</p>
      </div>
      <div class="system-status">
        <div class="status-indicator"><div class="status-dot status-online"></div><span id="uk-system-status-text">Brand data ready</span></div>
      </div>
      <div class="hub-tiles-5">
        <div class="hub-tile" onclick="goToScreen('uk-sizefinder')">AI Size Finder</div>
        <div class="hub-tile" onclick="goToScreen('uk-mysizes')">My Accurate Sizes</div>
        <div class="hub-tile" onclick="goToScreen('uk-brandnotes')">Brand Intelligence</div>
        <div class="hub-tile" onclick="goToScreen('uk-history')">Search History</div>
        <div class="hub-tile" onclick="goToScreen('uk-converters')">Size Converters</div>
      </div>
    </div>
  </div>

  <!-- UK Size Finder -->
  <div id="uk-sizefinder" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß AI Size Finder</h2>
        <p class="hub-subtitle">Find your perfect size using real brand measurements</p>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label class="form-label">Brand</label>
          <select class="form-select" id="uk-brand-select">
            <option value="">Select a brand...</option>
            <option>ASOS</option><option>Zara</option><option>H&M</option><option>Marks & Spencer</option><option>Next</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="uk-category-select">
            <option value="">Select category...</option>
            <option>Women's Jeans</option><option>Women's Dresses</option><option>Women's Tops</option><option>Women's Shoes</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Fit Preference</label>
          <select class="form-select" id="uk-fit-select">
            <option value="">Select fit...</option>
            <option value="Snug">Snug (Size down)</option>
            <option value="Standard">Standard (True to measurements)</option>
            <option value="Relaxed">Relaxed (Size up)</option>
          </select>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="getMySize()"><span id="size-finder-btn-text">Get My Perfect Size</span></button>
          <button class="btn btn-secondary" onclick="saveToHistory()">Save to History</button>
        </div>
        <div id="size-result" style="display:none;margin-top:16px;padding:16px;background:var(--card);border-radius:12px;border:2px solid var(--green)"></div>
      </div>
    </div>
  </div>

  <!-- UK My Sizes -->
  <div id="uk-mysizes" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">My Accurate Sizes</h2>
        <p class="hub-subtitle">Based on your measurements: 36" bust, 34" waist, 38" hips</p>
        <p style="font-size:14px;color:var(--muted)">All sizes calculated from brand charts</p>
      </div>
      <div class="system-status">
        <div class="status-indicator"><div class="status-dot status-online"></div><span>Showing sizes with 70%+ confidence</span></div>
      </div>
      <div class="form-group">
        <label class="form-label">Category Filter</label>
        <select class="form-select" id="mysizes-category">
          <option value="">All categories</option>
          <option>Women's Jeans</option><option>Women's Dresses</option><option>Women's Tops</option><option>Women's Shoes</option>
        </select>
      </div>
      <div class="brand-grid" id="my-sizes-grid">
        <div style="text-align:center;padding:24px;grid-column:1/-1;">
          <div class="loading-spinner"></div><p>Loading your accurate sizes‚Ä¶</p>
        </div>
      </div>
    </div>
  </div>

  <!-- UK Brand Notes -->
  <div id="uk-brandnotes" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß Brand Intelligence</h2>
        <p class="hub-subtitle">Quick notes about UK brands and their sizing</p>
      </div>
      <div class="brand-grid" id="brand-notes-grid"></div>
    </div>
  </div>

  <!-- UK History -->
  <div id="uk-history" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß Search History</h2>
        <p class="hub-subtitle">Your past AI size finder searches</p>
      </div>
      <div class="history-list" id="uk-history-list"></div>
    </div>
  </div>

  <!-- UK Converters -->
  <div id="uk-converters" class="screen">
    <div class="content-container">
      <div class="hub-header">
        <h2 class="hub-title">üá¨üáß Size Converters</h2>
        <p class="hub-subtitle">Convert between UK, US, CA, EU sizes</p>
      </div>
      <div class="hub-tiles">
        <div class="hub-tile" onclick="openConverter('dresses')">Dress Sizes</div>
        <div class="hub-tile" onclick="openConverter('jeans')">Jean Sizes</div>
        <div class="hub-tile" onclick="openConverter('tops')">Top Sizes</div>
        <div class="hub-tile" onclick="openConverter('shoes')">Shoe Sizes</div>
      </div>
    </div>
  </div>

  <!-- UK Settings -->
  <div id="uk-settings" class="screen">
    <div class="content-container">
      <div class="hub-header"><h2 class="hub-title">üá¨üáß Settings</h2><p class="hub-subtitle">Manage your profiles and preferences</p></div>

      <div class="brand-card">
        <h3 style="margin:0 0 8px;color:var(--brand)">ü§ñ AI System</h3>
        <div class="status-indicator"><div class="status-dot status-online"></div><span id="ai-status-text">AI sizing active - Last updated: <span id="last-update-time">Never</span></span></div>
      </div>

      <div class="brand-card">
        <h3 style="margin:0 0 8px;color:var(--brand)">üë§ Profiles</h3>
        <div class="form-group">
          <label class="form-label">Select Profile</label>
          <select class="form-select" id="measurement-profile-select"></select>
        </div>

        <div class="brand-grid">
          <div class="brand-card">
            <div class="form-group"><label class="form-label">Weight</label><input id="weight" type="number" class="form-input" placeholder="80"/></div>
            <div class="form-group"><label class="form-label">Chest/Bust (in)</label><input id="chest" type="number" class="form-input" placeholder="36"/></div>
          </div>
          <div class="brand-card">
            <div class="form-group"><label class="form-label">Waist (in)</label><input id="waist" type="number" class="form-input" placeholder="34"/></div>
            <div class="form-group"><label class="form-label">Hips (in)</label><input id="hips" type="number" class="form-input" placeholder="38"/></div>
          </div>
        </div>

        <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="saveMeasurementsToProfile()">Save Measurements & Update</button>
      </div>
    </div>
  </div>

  <!-- MiStats -->
  <div id="mistats" class="screen">
    <div class="content-container" style="padding-top:20px">
      <div class="hub-header"><h2 class="hub-title">MiStats</h2></div>

      <div class="form-group" style="max-width:320px;margin:0 auto 16px;">
        <label class="form-label" style="text-align:center;display:block;">Profile</label>
        <select class="form-select" id="mistats-profile-select"></select>
      </div>

      <div class="brand-grid" style="grid-template-columns:repeat(3,1fr);">
        <div class="brand-card"><div class="brand-name">Start</div><div id="start-weight">150kg</div><div id="start-bmi" style="color:var(--muted);font-size:14px">BMI: ‚Äî</div></div>
        <div class="brand-card"><div class="brand-name">Current</div><div id="current-weight">80kg</div><div id="current-bmi" style="color:var(--muted);font-size:14px">BMI: ‚Äî</div></div>
        <div class="brand-card"><div class="brand-name">Target</div><div id="target-weight">80kg</div><div id="target-bmi" style="color:var(--muted);font-size:14px">BMI: ‚Äî</div></div>
      </div>

      <div class="system-status">
        <div style="font-weight:700;margin-bottom:8px">Progress</div>
        <div style="width:100%;height:12px;background:var(--border);border-radius:6px;overflow:hidden">
          <div id="progress-fill" style="height:100%;width:0%;background:var(--green)"></div>
        </div>
        <p id="progress-text" style="margin-top:8px">Calculating‚Ä¶</p>
      </div>

      <div class="brand-card">
        <div class="brand-name">BMI Tracker</div>
        <div id="bmi-value" style="font-weight:900;font-size:24px">‚Äî</div>
        <div id="bmi-category" style="color:var(--muted)">‚Äî</div>
      </div>

      <div class="brand-card">
        <div class="brand-name">History</div>
        <div id="measurement-history">
          <div class="history-item"><div><strong>‚öñÔ∏è Weight: 80kg</strong><br><span class="history-date">Latest</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Regions (simple placeholders) -->
  <div id="eu-hub" class="screen"><div class="hub-container"><div class="hub-header"><div style="font-size:60px">üá™üá∫</div><h2 class="hub-title">EU Hub</h2><p class="hub-subtitle">European sizing & tracking</p></div><div class="hub-tiles-5"><div class="hub-tile" onclick="alert('EU features coming soon')">AI Size Finder</div><div class="hub-tile" onclick="alert('EU features coming soon')">My Sizes</div><div class="hub-tile" onclick="alert('EU features coming soon')">Brand Intelligence</div><div class="hub-tile" onclick="alert('EU features coming soon')">History</div><div class="hub-tile" onclick="alert('EU features coming soon')">Converters</div></div></div></div>
  <div id="us-hub" class="screen"><div class="hub-container"><div class="hub-header"><div style="font-size:60px">üá∫üá∏</div><h2 class="hub-title">US Hub</h2><p class="hub-subtitle">United States sizing & tracking</p></div><div class="hub-tiles-5"><div class="hub-tile" onclick="alert('US features coming soon')">AI Size Finder</div><div class="hub-tile" onclick="alert('US features coming soon')">My Sizes</div><div class="hub-tile" onclick="alert('US features coming soon')">Brand Intelligence</div><div class="hub-tile" onclick="alert('US features coming soon')">History</div><div class="hub-tile" onclick="alert('US features coming soon')">Converters</div></div></div></div>
  <div id="ca-hub" class="screen"><div class="hub-container"><div class="hub-header"><div style="font-size:60px">üá®üá¶</div><h2 class="hub-title">Canada Hub</h2><p class="hub-subtitle">Canadian sizing & tracking</p></div><div class="hub-tiles-5"><div class="hub-tile" onclick="alert('CA features coming soon')">AI Size Finder</div><div class="hub-tile" onclick="alert('CA features coming soon')">My Sizes</div><div class="hub-tile" onclick="alert('CA features coming soon')">Brand Intelligence</div><div class="hub-tile" onclick="alert('CA features coming soon')">History</div><div class="hub-tile" onclick="alert('CA features coming soon')">Converters</div></div></div></div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="goHome()">Home</button>
    <button class="nav-item" onclick="goToMiStats()">MiStats</button>
    <button class="nav-item" onclick="goToSettings()">Settings</button>
    <button class="nav-item" onclick="goToHelp()">Help</button>
    <button class="nav-item" onclick="goBack()">Back</button>
  </div>

    <script>
// ===== Global State =====
let currentScreen = 'home';
let navigationHistory = ['home'];
let selectedBodyType = 'standard';
let selectedUnit = 'cm';
let currentProfile = 'Emma Morris';
let miSizeSystem = null; // reserved if you expand to a class later

// ===== Profiles (minimal but extensible) =====
let profileData = {
  'Emma Morris': {
    name:'Emma Morris',
    dateOfBirth:'1983-10-12',
    gender:'female',
    startingDate:'2022-03-19',
    startingWeight:{ value:150, unit:'kg' },
    startingHeight:{ value:183, unit:'cm' },
    targetWeight:{ value:80, unit:'kg' },
    measurements:{ weight:80, chest:36, waist:34, hips:38 },
    history:[
      { date:'2022-03-19', type:'weight', value:150, unit:'kg' },
      { date:'2023-08-19', type:'weight', value:80, unit:'kg' },
      { date:'2024-12-19', type:'waist', value:34, unit:'inch' },
      { date:'2024-12-19', type:'hips', value:38, unit:'inch' },
      { date:'2024-12-19', type:'chest', value:36, unit:'inch' }
    ]
  }
};

// ===== Brand DB (sample set; add more any time) =====
const BRAND_SIZE_DATABASE = {
  'ASOS': {
    notes:'UK sizes, runs slightly large',
    categories:{
      "Women's Tops": { '12':{bust:36,waist:30,hips:38}, '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
      "Women's Dresses": { '12':{bust:36,waist:30,hips:38}, '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
      "Women's Jeans": { '12':{waist:30,hips:38}, '14':{waist:32,hips:40}, '16':{waist:34,hips:42}, '18':{waist:36,hips:44} }
    }
  },
  'Zara': {
    notes:'Trims closer; consider one up for fitted items',
    categories:{
      "Women's Tops": { 'L':{bust:37,waist:30,hips:39}, 'XL':{bust:39,waist:32,hips:41} },
      "Women's Dresses": { 'L':{bust:37,waist:30,hips:39}, 'XL':{bust:39,waist:32,hips:41} },
      "Women's Jeans": { '40':{waist:31,hips:39}, '42':{waist:33,hips:41}, '44':{waist:35,hips:43} }
    }
  },
  'H&M': {
    notes:'Often true to size',
    categories:{
      "Women's Tops": { 'M':{bust:36,waist:30,hips:38}, 'L':{bust:38,waist:32,hips:40} },
      "Women's Dresses": { 'M':{bust:36,waist:30,hips:38}, 'L':{bust:38,waist:32,hips:40} },
      "Women's Jeans": { '12':{waist:30,hips:38}, '14':{waist:32,hips:40}, '16':{waist:34,hips:42} }
    }
  },
  'Marks & Spencer': {
    notes:'Consistent charts; generous at hips',
    categories:{
      "Women's Tops": { '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
      "Women's Dresses": { '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
      "Women's Jeans": { '14':{waist:32,hips:40}, '16':{waist:34,hips:42}, '18':{waist:36,hips:44} }
    }
  },
  'Next': {
    notes:'Between ASOS and M&S; fairly true',
    categories:{
      "Women's Tops": { '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
      "Women's Dresses": { '14':{bust:38,waist:32,hips:40}, '16':{bust:40,waist:34,hips:42} },
      "Women's Jeans": { '14':{waist:32,hips:40}, '16':{waist:34,hips:42}, '18':{waist:36,hips:44} }
    }
  }
};
</script>

    <script>
// ===== Navigation & Screen Management =====
function goToScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.add('active');
  currentScreen = id;
  navigationHistory.push(id);
  updateNavigation();
  updateScreenData(id);
}
function updateNavigation(){
  const items = document.querySelectorAll('.bottom-nav .nav-item');
  items.forEach(i=>i.classList.remove('active'));
  const map = {home:0, mistats:1, 'uk-settings':2, help:3};
  const idx = map[currentScreen];
  if(idx!==undefined) items[idx].classList.add('active');
}
function updateScreenData(id){
  if(id==='uk-mysizes') renderMySizes();
  if(id==='uk-brandnotes') populateBrandNotes();
  if(id==='uk-history') renderHistory();
  if(id==='uk-settings') populateProfileDropdown();
  if(id==='mistats'){ populateMiStatsProfileSelect(); renderMiStats(); }
}
function goBack(){
  navigationHistory.pop();
  const prev = navigationHistory.pop() || 'home';
  goToScreen(prev);
}
function goHome(){ goToScreen('home'); }
function goToMiStats(){ goToScreen('mistats'); }
function goToSettings(){ goToScreen('uk-settings'); }
function goToHelp(){ goToScreen('help'); }
function enterHub(region){
  if(region==='UK') goToScreen('uk-hub');
  else if(region==='EU') goToScreen('eu-hub');
  else if(region==='US') goToScreen('us-hub');
  else if(region==='CA') goToScreen('ca-hub');
}

// ===== Pills =====
function setupPillControls(){
  document.addEventListener('click',(e)=>{
    if(e.target.matches('#bodytype-pills .pill')){
      document.querySelectorAll('#bodytype-pills .pill').forEach(p=>p.classList.remove('active'));
      e.target.classList.add('active'); selectedBodyType = e.target.dataset.type; refreshDebug();
    }
    if(e.target.matches('#unit-pills .pill')){
      document.querySelectorAll('#unit-pills .pill').forEach(p=>p.classList.remove('active'));
      e.target.classList.add('active'); selectedUnit = e.target.dataset.unit; refreshDebug();
    }
  });
}

// ===== Debug =====
function toggleDebugPanel(){ document.getElementById('debug-panel').classList.toggle('open'); }
function refreshDebug(){
  const p = profileData[currentProfile];
  const msg = [
    `Time: ${new Date().toLocaleTimeString()}`,
    `Profile: ${currentProfile}`,
    `Body: ${selectedBodyType}`,
    `Unit: ${selectedUnit}`,
    `B/W/H (in): ${p.measurements.chest}/${p.measurements.waist}/${p.measurements.hips}`
  ].join(' ‚Ä¢ ');
  document.getElementById('debug-info').innerText = msg;
  document.getElementById('system-status-dot').className='status-dot status-online';
  document.getElementById('system-status-text').innerText='Intelligent sizing system ready';
  document.getElementById('last-update-time')?.innerText = new Date().toLocaleString();
}

// ===== Brand Notes =====
function populateBrandNotes(){
  const grid = document.getElementById('brand-notes-grid');
  grid.innerHTML = Object.entries(BRAND_SIZE_DATABASE).map(([name,data])=>`
    <div class="brand-card">
      <div class="brand-name">${name}</div>
      <div style="font-size:13px;color:var(--muted)">${data.notes}</div>
    </div>
  `).join('');
}

// ===== My Sizes =====
function renderMySizes(){
  const grid = document.getElementById('my-sizes-grid');
  const p = profileData[currentProfile]?.measurements;
  if(!p){ grid.innerHTML = `<div class="brand-card" style="grid-column:1/-1">No profile selected.</div>`; return; }

  const filter = document.getElementById('mysizes-category')?.value || '';
  const results = [];
  Object.entries(BRAND_SIZE_DATABASE).forEach(([brand,data])=>{
    Object.entries(data.categories).forEach(([cat, sizes])=>{
      if(filter && cat!==filter) return;
      const rec = pickBestSize(cat, sizes, p);
      if(rec) results.push({brand,cat,rec,notes:data.notes});
    });
  });

  if(results.length===0){
    grid.innerHTML = `<div class="brand-card" style="grid-column:1/-1">No sizes yet. Try the AI Size Finder.</div>`;
    return;
  }
  grid.innerHTML = results.slice(0,10).map(r=>{
    const conf = Math.round(r.rec.confidence*100);
    return `<div class="brand-card">
      <div class="brand-name">${r.brand} ‚Äî ${r.cat}</div>
      <div><span class="brand-size">${r.rec.size}</span><span class="confidence-indicator">${conf}%</span></div>
      <div style="font-size:13px;color:var(--muted)">${r.notes}</div>
    </div>`;
  }).join('');
}

// ===== AI Size Finder =====
function getMySize(){
  const brand = document.getElementById('uk-brand-select').value;
  const cat = document.getElementById('uk-category-select').value;
  const fit = document.getElementById('uk-fit-select').value || 'Standard';
  const out = document.getElementById('size-result');
  const p = profileData[currentProfile]?.measurements;

  if(!brand || !cat){ out.style.display='block'; out.style.borderColor='var(--orange)'; out.innerHTML='Please choose a brand and category.'; out.dataset.summary='Incomplete'; return; }
  const db = BRAND_SIZE_DATABASE[brand];
  if(!db || !db.categories[cat]){ out.style.display='block'; out.style.borderColor='var(--orange)'; out.innerHTML='No chart for this brand/category yet.'; out.dataset.summary='No chart'; return; }
  const rec = pickBestSize(cat, db.categories[cat], p, fit);
  if(!rec){ out.style.display='block'; out.style.borderColor='var(--orange)'; out.innerHTML='Couldn‚Äôt find a close match.'; out.dataset.summary='No match'; return; }

  const confPct = Math.round(rec.confidence*100);
  out.style.display='block';
  out.style.borderColor='var(--green)';
  out.innerHTML = `<strong>Recommended Size:</strong> ${rec.size} <span class="confidence-indicator">${confPct}% match</span>
    <div style="margin-top:8px;font-size:14px;color:var(--muted)">${brand} ‚Ä¢ ${cat} ‚Ä¢ Fit: ${fit}</div>
    <div style="margin-top:8px;font-size:13px">Why: minimal difference to your key measurements for this category.</div>`;
  out.dataset.summary = `Size ${rec.size}, ${confPct}% match`;
}

function pickBestSize(category, sizesMap, meas, fit='Standard'){
  let best=null;
  Object.keys(sizesMap).forEach(size=>{
    const chart = sizesMap[size];
    let diffs=[];
    if(category.includes('Jeans')){
      if(chart.waist!==undefined) diffs.push(Math.abs(chart.waist - meas.waist));
      if(chart.hips!==undefined) diffs.push(Math.abs(chart.hips - meas.hips));
    }else if(category.includes('Tops')){
      if(chart.bust!==undefined) diffs.push(Math.abs(chart.bust - meas.chest));
      if(chart.waist!==undefined) diffs.push(Math.abs(chart.waist - meas.waist));
    }else if(category.includes('Dresses')){
      if(chart.bust!==undefined) diffs.push(Math.abs(chart.bust - meas.chest));
      if(chart.waist!==undefined) diffs.push(Math.abs(chart.waist - meas.waist));
      if(chart.hips!==undefined) diffs.push(Math.abs(chart.hips - meas.hips));
    }else{
      Object.entries(chart).forEach(([k,v])=>{
        if(k==='bust') diffs.push(Math.abs(v - meas.chest));
        if(k==='waist') diffs.push(Math.abs(v - meas.waist));
        if(k==='hips') diffs.push(Math.abs(v - meas.hips));
      });
    }
    const avgDiff = diffs.length?(diffs.reduce((a,b)=>a+b,0)/diffs.length):999;
    let bias=0; if(fit==='Snug') bias=-0.3; if(fit==='Relaxed') bias=0.3;
    const score = avgDiff + bias;
    if(!best || score<best.score){
      const confidence = Math.max(0, 1 - (avgDiff/4)); // simple 0‚Äì1
      best = { size, score, confidence };
    }
  });
  return best;
}

// ===== History =====
const historyItems = [];
function saveToHistory(){
  const brand = document.getElementById('uk-brand-select').value || '‚Äî';
  const cat = document.getElementById('uk-category-select').value || '‚Äî';
  const resultEl = document.getElementById('size-result');
  const line = resultEl.style.display==='none' ? 'No recommendation yet' : (resultEl.dataset.summary || '‚Äî');
  historyItems.unshift({brand,cat,summary:line,date:new Date()});
  renderHistory();
  alert('Saved to history');
}
function renderHistory(){
  const list = document.getElementById('uk-history-list');
  if(historyItems.length===0){
    list.innerHTML = `<div class="history-item"><div><strong>No history yet</strong><br><span class="history-date">Use the AI Size Finder first</span></div></div>`;
    return;
  }
  list.innerHTML = historyItems.slice(0,12).map(h=>`
    <div class="history-item">
      <div><strong>${h.brand} - ${h.cat}</strong><br><span class="history-date">${h.summary} ‚Ä¢ ${h.date.toLocaleString()}</span></div>
    </div>
  `).join('');
}

// ===== Profiles (Settings) =====
function populateProfileDropdown(){
  const sel = document.getElementById('measurement-profile-select');
  if(!sel) return;
  sel.innerHTML = Object.keys(profileData).map(n=>`<option>${n}</option>`).join('');
  sel.value = currentProfile;
  loadSelectedProfileMeasurements();
  sel.onchange = (e)=>{ currentProfile = e.target.value; loadSelectedProfileMeasurements(); refreshDebug(); };
}
function loadSelectedProfileMeasurements(){
  const p = profileData[currentProfile]?.measurements;
  if(!p) return;
  document.getElementById('weight').value = p.weight;
  document.getElementById('chest').value = p.chest;
  document.getElementById('waist').value = p.waist;
  document.getElementById('hips').value = p.hips;
}
function saveMeasurementsToProfile(){
  const p = profileData[currentProfile];
  const n = (id)=>Number(document.getElementById(id).value);
  const w=n('weight'), c=n('chest'), wa=n('waist'), h=n('hips');
  if([w,c,wa,h].some(x=>Number.isNaN(x)||x<=0)){ alert('Please enter valid numbers'); return; }
  p.measurements = { weight:w, chest:c, waist:wa, hips:h };
  alert('Measurements saved.');
  renderMySizes(); refreshDebug(); renderMiStats();
}

// ===== Help / Misc =====
function toggleGuide(id){
  const el = document.getElementById(id);
  if(el) el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none';
}
function reportIssue(){ alert('Thanks! A feedback form will be added here.'); }
function showMeasurementGuide(type){ alert('Guide: '+type); }
function openConverter(kind){ alert(kind.toUpperCase()+' converter coming soon'); }

// ===== App Boot =====
function setupEventListeners(){
  document.getElementById('mysizes-category')?.addEventListener('change', renderMySizes);
}
<script>
// ===== MiStats =====
function populateMiStatsProfileSelect(){
  const sel = document.getElementById('mistats-profile-select');
  if(!sel) return;
  sel.innerHTML = Object.keys(profileData).map(n=>`<option>${n}</option>`).join('');
  sel.value = currentProfile;
  sel.onchange = (e)=>{ setCurrentProfile(e.target.value); };
}
function setCurrentProfile(name){
  currentProfile = name;
  populateProfileDropdown();
  renderMySizes();
  renderMiStats();
  refreshDebug();
}
function renderMiStats(){
  const p = profileData[currentProfile];
  if(!p) return;

  const allWeightEntries = p.history.filter(h=>h.type==='weight');
  const startKg = kgFrom(p.startingWeight.value, p.startingWeight.unit);
  const heightCm = cmFrom(p.startingHeight.value, p.startingHeight.unit);
  const targetKg = p.targetWeight ? kgFrom(p.targetWeight.value, p.targetWeight.unit) : null;

  const latestWeightEntry = allWeightEntries[allWeightEntries.length-1] || { value:p.measurements.weight, unit:'kg' };
  const currentKg = kgFrom(latestWeightEntry.value, latestWeightEntry.unit);

  // Write Start/Current/Target
  document.getElementById('start-weight').textContent = `${Math.round(startKg)}kg`;
  document.getElementById('current-weight').textContent = `${Math.round(currentKg)}kg`;
  if(targetKg!=null) document.getElementById('target-weight').textContent = `${Math.round(targetKg)}kg`;

  // BMI values
  const startBmi = computeBMIKgCm(startKg, heightCm);
  const currentBmi = computeBMIKgCm(currentKg, heightCm);
  const targetBmi = targetKg!=null ? computeBMIKgCm(targetKg, heightCm) : null;

  if(startBmi) document.getElementById('start-bmi').textContent = `BMI: ${(Math.round(startBmi*10)/10)}`;
  if(currentBmi){
    document.getElementById('current-bmi').textContent = `BMI: ${(Math.round(currentBmi*10)/10)}`;
    const bmiValEl = document.getElementById('bmi-value');
    const bmiCatEl = document.getElementById('bmi-category');
    if(bmiValEl) bmiValEl.textContent = (Math.round(currentBmi*10)/10).toString();
    if(bmiCatEl) bmiCatEl.textContent = getBmiCategory(currentBmi); // uses polyfill below if needed
  }
  if(targetBmi!=null) document.getElementById('target-bmi').textContent = `BMI: ${(Math.round(targetBmi*10)/10)}`;

  // Progress
  const lostKg = Math.max(0, startKg - currentKg);
  const remainingKg = (targetKg!=null) ? Math.max(0, currentKg - targetKg) : 0;
  const totalDelta = (targetKg!=null) ? Math.max(0.0001, startKg - targetKg) : 1;
  const progressPct = (targetKg!=null) ? Math.min(100, Math.max(0, (lostKg/totalDelta)*100)) : 100;
  document.getElementById('progress-fill').style.width = `${progressPct}%`;
  document.getElementById('progress-text').textContent = (targetKg!=null)
    ? (remainingKg<=0 ? 'üéâ Goal Achieved!' : `Progress: ${Math.round(progressPct)}% ‚Ä¢ Remaining ${Math.round(remainingKg)}kg`)
    : 'Tracking current status';

  // History list (simple)
  const hist = document.getElementById('measurement-history');
  hist.innerHTML = allWeightEntries.slice(-6).reverse().map(e=>`
    <div class="history-item"><div><strong>‚öñÔ∏è Weight: ${e.value}${e.unit}</strong><br><span class="history-date">${e.date}</span></div></div>
  `).join('') || `<div class="history-item"><div><strong>No entries</strong></div></div>`;
}

// ===== BMI/Unit Helpers =====
function kgFrom(value, unit){
  if(!unit || unit==='kg') return Number(value);
  if(unit==='lbs' || unit==='lb') return Number(value)*0.45359237;
  if(unit==='stone' || unit==='st') return Number(value)*6.35029318;
  return Number(value)||0;
}
function cmFrom(value, unit){
  if(!unit || unit==='cm') return Number(value);
  if(unit==='inch' || unit==='in') return Number(value)*2.54;
  if(unit==='m') return Number(value)*100;
  return Number(value)||0;
}
function computeBMIKgCm(kg, cm){
  const m = Number(cm)/100;
  if(!m || !kg) return null;
  return kg/(m*m);
}
// keep your original name
function bmiCategory(bmi){
  if(bmi<18.5) return 'Underweight';
  if(bmi<25) return 'Normal Weight';
  if(bmi<30) return 'Overweight';
  return 'Obese';
}
// polyfill so existing calls to getBmiCategory keep working
if(typeof getBmiCategory!=='function'){
  function getBmiCategory(bmi){ return bmiCategory(bmi); }
}

// ===== Init =====
function initApp(){
  setupPillControls();
  setupEventListeners();
  populateProfileDropdown();
  populateMiStatsProfileSelect();
  renderMySizes();
  populateBrandNotes();
  renderHistory();
  refreshDebug();
}
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
