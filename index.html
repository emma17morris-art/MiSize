<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Fit App</title>
<style>
:root{
  --bg:#0f131a; --card:#151a22; --border:#243048; --muted:#aab3c5;
}
body{margin:0;font-family:sans-serif;background:var(--bg);color:#eef1f5;}
h1,h2,h3{margin:0;font-weight:700;}
.big{font-size:18px;}
.note{font-size:13px;color:var(--muted);}
.screen{display:none;padding:18px;max-width:900px;margin:0 auto;}
.screen.active{display:block;}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:18px;}
.row{display:grid;grid-gap:12px;}
.row.two{grid-template-columns:repeat(2,1fr);}
.row.three{grid-template-columns:repeat(3,1fr);}
label{font-size:13px;color:var(--muted);}
select,input{width:100%;padding:8px;border-radius:10px;border:1px solid #243048;background:#0f131a;color:#eef1f5;}
button{cursor:pointer}
button.pill{padding:6px 12px;border-radius:16px;border:1px solid #243048;background:#1d2430;color:#eef1f5;}
.pill-row{display:flex;flex-wrap:wrap;gap:8px;}
.profile-pill{padding:4px 10px;border-radius:14px;border:1px solid #243048;background:#1d2430;color:#eef1f5;}
.profile-pill.active{background:#5da8ff;color:#fff;}
.profile-pill.add{border-style:dashed;}

/* Topbar smaller */
.topbar{position:sticky;top:0;z-index:100;backdrop-filter:saturate(120%) blur(8px);background:rgba(15,19,26,.75);border-bottom:1px solid var(--border);padding:6px 10px;}
.topbar-inner{display:flex;gap:8px;align-items:center;flex-wrap:wrap;max-width:1200px;margin:0 auto;}
.topbar h1{font-size:14px;margin:0 6px 0 0;font-weight:800;letter-spacing:.2px;color:#cfe0ff;}

/* Bottom tabs */
.bottom-tabs{position:sticky;bottom:0;display:flex;justify-content:space-around;background:#151a22;border-top:1px solid var(--border);}
.bottom-tabs .tab{flex:1;padding:10px;border:none;background:none;color:#eef1f5;}
.bottom-tabs .tab.active{background:#243048;}

/* Profile tweaks */
#profile select,#profile input{padding:10px;font-size:14px;border-radius:10px;}
@media (min-width:760px){
  #profile .row.two{grid-template-columns:repeat(3,1fr);}
}

/* MiStats graph */
#mi_canvas{width:100%;height:220px;background:#0f131a;border:1px solid var(--border);border-radius:8px;}
.mi-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);}
.mi-row:last-child{border-bottom:none;}
.delta.down{color:#5da8ff;}
.delta.up{color:#ff9a9a;}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner">
    <h1>My Fit App</h1>
    <div class="pill-row" id="bodyTypePills"></div>
    <div class="pill-row" id="unitPills"></div>
  </div>
</div>

<!-- Splash -->
<section id="splash" class="screen active">
  <h2 class="big">Loading…</h2>
</section>

<!-- Hubs -->
<section id="home" class="screen"><h2 class="big">Home Hub</h2></section>
<section id="uk" class="screen"><h2 class="big">UK Hub</h2></section>
<section id="eu" class="screen"><h2 class="big">EU Hub</h2></section>
<section id="us" class="screen"><h2 class="big">US Hub</h2></section>
<section id="ca" class="screen"><h2 class="big">CA Hub</h2></section>

<!-- Profile -->
<section id="profile" class="screen">
  <h2 class="big">Profile</h2>
  <div class="card">
    <div class="row two">
      <div><label>Name</label><input id="m_name"></div>
      <div><label>Sex</label>
        <select id="m_sex">
          <option value="female">Female</option>
          <option value="male">Male</option>
        </select>
      </div>
      <div><label>Height</label><input id="m_height"></div>
      <div><label>Bust</label><input id="m_bust"></div>
      <div><label>Waist</label><input id="m_waist"></div>
      <div><label>Hip</label><input id="m_hip"></div>
      <div><label>Thigh</label><input id="m_thigh"></div>
      <div><label>Calf</label><input id="m_calf"></div>
      <div><label>Neck</label><input id="m_neck"></div>
    </div>
  </div>
</section>

<!-- MiStats -->
<section id="mistats" class="screen">
  <h2 class="big">MiStats</h2>
  <div class="card" id="mi_view_current"></div>
  <div class="card"><canvas id="mi_canvas" width="900" height="260"></canvas><p id="mi_graph_note" class="note"></p></div>
  <div class="card" id="mi_view_history"></div>
</section>

<!-- Settings -->
<section id="settings" class="screen">
  <h2 class="big">Settings</h2>
  <div class="card">
    <div class="row two">
      <div>
        <div class="big">Profiles</div>
        <p class="note">Switch or add profiles here.</p>
      </div>
      <div style="display:flex;align-items:center;justify-content:flex-end;">
        <button class="pill" onclick="switchTab('profile')">Open Profile editor</button>
      </div>
    </div>
    <div id="profilePillsSettings" class="pill-row" style="margin-top:10px;"></div>
  </div>
  <div id="global_weight_units_card" class="card"></div>
</section>

<!-- Bottom Tabs -->
<div class="bottom-tabs" role="tablist">
  <button id="tab_home" class="tab active" onclick="switchTab('home')">Home</button>
  <button id="tab_profile" class="tab" onclick="switchTab('profile')">Profile</button>
  <button id="tab_mistats" class="tab" onclick="switchTab('mistats')">MiStats</button>
  <button id="tab_settings" class="tab" onclick="switchTab('settings')">Settings</button>
  <button id="tab_hub" class="tab" onclick="hubBack()">Hub</button>
</div>

<script>
/* ========= Tiny helpers ========= */
const NAV_STACK=[];
let CURRENT_SCREEN='home';
const $ = (id)=>document.getElementById(id);

/* ========= Navigation ========= */
function switchTab(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  ( $(id) || $('home') ).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  const t = $('tab_'+id); if(t) t.classList.add('active');
  CURRENT_SCREEN=id;
}
function hubBack(){
  if (CURRENT_SCREEN && CURRENT_SCREEN.startsWith('uk_')){ switchTab('uk'); return; }
  if (!['home','uk','eu','us','ca','profile','mistats','settings','splash'].includes(CURRENT_SCREEN)){
    switchTab('home'); return;
  }
  switchTab('home');
}

/* ========= Profiles (stored in localStorage) ========= */
function getProfilesAndActive(){
  let arr=JSON.parse(localStorage.getItem('profiles')||'[]');
  let act=localStorage.getItem('activeProfileId');
  if(!arr.length){
    arr=[{id:'p1',name:'Default',sex:'female',height:null,bust:null,waist:null,hip:null,thigh:null,calf:null,neck:null}];
    act='p1';
    localStorage.setItem('profiles',JSON.stringify(arr));
    localStorage.setItem('activeProfileId',act);
  }
  // ensure active exists
  if(!arr.find(p=>p.id===act)){ act=arr[0].id; localStorage.setItem('activeProfileId',act); }
  return {profiles:arr, activeId:act};
}
function saveProfiles(p){ localStorage.setItem('profiles', JSON.stringify(p)); }

function renderProfilePills(){
  const {profiles, activeId}=getProfilesAndActive();
  const frag=document.createDocumentFragment();
  profiles.forEach(p=>{
    const b=document.createElement('button');
    b.className='profile-pill'+(p.id===activeId?' active':'');
    b.dataset.id=p.id; b.textContent=p.name; frag.appendChild(b);
  });
  const add=document.createElement('button');
  add.className='profile-pill add'; add.dataset.action='add-profile'; add.textContent='+ Add profile';
  frag.appendChild(add);
  const host=$('profilePillsSettings');
  if(host){ host.innerHTML=''; host.appendChild(frag); }
}

// profile pill interactions (in Settings)
document.addEventListener('click',e=>{
  const b=e.target.closest('.profile-pill'); if(!b) return;
  if(b.dataset.action==='add-profile'){
    const name=prompt('Profile name?','Profile '+(getProfilesAndActive().profiles.length+1));
    if(!name) return;
    const {profiles}=getProfilesAndActive();
    const id='p'+Math.random().toString(36).slice(2,7);
    profiles.push({id,name,sex:'female',height:null,bust:null,waist:null,hip:null,thigh:null,calf:null,neck:null});
    saveProfiles(profiles);
    localStorage.setItem('activeProfileId',id);
    renderProfilePills();
    refreshAll();
    return;
  }
  localStorage.setItem('activeProfileId',b.dataset.id);
  renderProfilePills();
  refreshAll();
});

/* ========= MiStats (weight entries + simple measures hook) ========= */
(function(){
  const STORE_KEY='mistats_v2';

  function load(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'{}'); }catch(e){ return {}; } }
  function save(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
  function getBucket(){
    const S=load();
    const {activeId}=getProfilesAndActive();
    if(!S[activeId]) S[activeId]={unitW:'kg', entries:[], measures:[]};
    return {s:S, b:S[activeId], id:activeId};
  }

  // expose a couple utils
  window.getBucket = getBucket;
  window.refreshAll = refreshAll;

  // ——— renderers
  function renderCurrent(){
    const {b}=getBucket(); const E=b.entries;
    const box=$('mi_view_current'); if(!box)return;
    if(!E.length){
      box.innerHTML=`
        <div class="row two">
          <div>
            <div class="big">No entries yet</div>
            <p class="note">Add weights programmatically or via future UI.</p>
          </div>
          <div class="note">Unit: ${b.unitW}</div>
        </div>`;
      return;
    }
    const start=E[0], curr=E[E.length-1];
    const lost=(start.kg-curr.kg).toFixed(1);
    box.innerHTML=`<div class="big">Current weight ${formatUnit(curr.kg,b.unitW)}</div>
      <p class="note">Start: ${formatUnit(start.kg,b.unitW)} • Lost: ${formatUnit(+lost,b.unitW)}</p>`;
  }

  function renderHistory(){
    const {b}=getBucket(); const E=b.entries; const box=$('mi_view_history'); if(!box)return;
    if(!E.length){ box.innerHTML='<p class="note">No history yet</p>'; return; }
    box.innerHTML=E.map(e=>`<div class="mi-row"><div>${e.d}</div><div>${formatUnit(e.kg,b.unitW)}</div></div>`).join('');
  }

  function miDrawGraph(){
    const {b}=getBucket(); const E=b.entries;
    const c=$('mi_canvas'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
    if(E.length<2){ $('mi_graph_note').textContent='Need 2+ entries'; return; }

    // scale
    const min=Math.min(...E.map(e=>e.kg)), max=Math.max(...E.map(e=>e.kg));
    const left=40, top=10, right=10, bottom=24;
    const W=c.width-left-right, H=c.height-top-bottom;

    // axes
    ctx.strokeStyle='#243048'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(left, top); ctx.lineTo(left, top+H); ctx.lineTo(left+W, top+H); ctx.stroke();

    // line
    ctx.strokeStyle='#5da8ff'; ctx.fillStyle='#5da8ff'; ctx.lineWidth=2; ctx.beginPath();
    E.forEach((e,i)=>{
      const x=left+(i/(E.length-1))*W;
      const y=top+H-(e.kg-min)/(Math.max(0.0001,(max-min)))*H;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      ctx.beginPath(); ctx.arc(x,y,2,0,Math.PI*2); ctx.fill();
    });
    ctx.stroke();

    $('mi_graph_note').textContent = `${E.length} points • unit ${b.unitW}`;
  }

  // ——— units
  function formatUnit(kg, unitW){
    if(unitW==='kg') return kg.toFixed(1)+' kg';
    if(unitW==='lb') return (kg/0.45359237).toFixed(1)+' lb';
    if(unitW==='st') return (kg/6.35029318).toFixed(2)+' st';
    return kg.toFixed(1)+' kg';
  }

  // public refresh
  function refreshAll(){
    renderCurrent();
    renderHistory();
    miDrawGraph();
  }

  // seed example data for quick demo (only if empty)
  (function seed(){
    const {s,b}=getBucket();
    if(!b.entries.length){
      const today=new Date();
      const d=(off)=> new Date(today.getTime()+off*86400000).toISOString().slice(0,10);
      b.entries=[
        {d:d(-20), kg:80.0},
        {d:d(-15), kg:79.2},
        {d:d(-10), kg:78.9},
        {d:d(-5),  kg:78.3},
        {d:d(0),   kg:77.8},
      ];
      save(s);
    }
  })();

  // first paint
  refreshAll();
})();

/* ========= Global weight units card (in Settings) ========= */
(function buildGlobalWeightUnitCard(){
  const card=$('global_weight_units_card'); if(!card)return;

  card.innerHTML=`
    <div class="row two">
      <div>
        <div class="big">Weight units</div>
        <p class="note">Choose how weight is shown across MiStats.</p>
      </div>
      <div class="pill-row">
        <button class="pill" data-wu="kg">Kilograms</button>
        <button class="pill" data-wu="lb">Pounds</button>
        <button class="pill" data-wu="st">Stones</button>
      </div>
    </div>`;

  // mark active btn
  const markActive = ()=>{
    const {b}=getBucket();
    card.querySelectorAll('[data-wu]').forEach(x=>{
      x.classList.toggle('active', x.dataset.wu===b.unitW);
    });
  };
  markActive();

  card.addEventListener('click',e=>{
    const btn=e.target.closest('[data-wu]'); if(!btn) return;
    const {id}=getBucket(); // active profile id
    // write unit directly to storage (no need to reach into MiStats closure)
    let store={}; try{ store=JSON.parse(localStorage.getItem('mistats_v2')||'{}'); }catch(_){}
    if(!store[id]) store[id]={unitW:'kg', entries:[], measures:[]};
    store[id].unitW = btn.dataset.wu;
    localStorage.setItem('mistats_v2', JSON.stringify(store));
    markActive();
    refreshAll();
  });
})();

/* ========= Boot ========= */
window.addEventListener('load', ()=>{
  // Splash -> Home
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  $('splash').classList.add('active');
  setTimeout(()=>{
    $('splash').classList.remove('active');
    switchTab('home');
  }, 500);

  renderProfilePills();
});
</script>
</body>
</html>
