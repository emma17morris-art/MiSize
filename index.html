<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MiSize Prototype</title>

  <!-- ========== STYLES ========== -->
  <style>
  /* ===== SPLASH (simple, large centered logo) ===== */
  #splash { display:none; padding:0; }
  #splash.active { display:block; }

  .splash-stage{
    position:relative; height:100vh; width:100%;
    display:flex; align-items:center; justify-content:center;
    background:#2b1055; /* deep purple instead of dark */
    overflow:hidden;
  }

  /* Single visual logo (no <img>, no animation) */
  .flash-logo-wrap{
    line-height:0;
    width: min(75vw, 560px);  /* large */
    aspect-ratio: 1 / 1;
    background: center / contain no-repeat url('MiSize.png');
    margin: 0 auto;           /* centered */
    transform: none;
    animation: none;
    opacity: 1;
    z-index: 1;
  }

  /* Hide the old shine layer completely (even if present in HTML) */
  .flash-logo-shine{ display:none !important; }

  /* ===== THEME / LAYOUT ===== */
  :root {
    --brand:#8A2BE2; --brand-text:#fff;
    --bg:#0b0d12; --card:#111520;
    --border:#1b2230; --text:#eef1f5; --muted:#aab3c5;
    --radius:14px;
    --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:var(--font); background:var(--bg); color:var(--text); }

  .screen{
    display:none;
    padding:20px 20px 90px;
    background:#2b1055;        /* purple app background */
    min-height:100vh;          /* full screen */
    box-sizing:border-box;
  }
  .screen.active{ display:block; }

  .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:18px; }
  .row{ display:grid; grid-template-columns:1fr; gap:12px; }
  @media (min-width:760px){
    .row.two{ grid-template-columns:1fr 1fr; }
    .row.three{ grid-template-columns: repeat(3,1fr); }
  }
  label{ font-size:14px; color:var(--muted); }
  select, input{ width:100%; padding:12px; border-radius:10px; border:1px solid #243048; background:#0f131a; color:#eef1f5; }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
  .cta{ background:var(--brand); color:var(--brand-text); border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer; }
  .ghost{ background:#182034; color:#eef1f5; border:1px solid #223049; padding:12px 16px; border-radius:12px; font-weight:600; cursor:pointer; }
  .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#172034; border:1px solid #223049; font-size:12px; color:#c9d3ea; }
  .big{ font-size:28px; font-weight:800; margin:0 0 6px; }
  .note{ font-size:13px; opacity:.85; }
  .divider{ height:1px; background:var(--border); margin:14px 0; }
  .success{ color:#8ee0b2; } .warning{ color:#ffd27a; } .danger{ color:#ff9a9a; }

  /* ===== HOME REGION TILES (1x4 full height) ===== */
  .tiles{
    display:grid;
    grid-template-columns:1fr;
    grid-template-rows: repeat(4,1fr);
    gap:16px;
    height:calc(100vh - 150px);
    margin-top:20px;
  }
  .tiles button{
    font-size:28px; font-weight:800;
    border-radius:14px; border:0; color:#fff; cursor:pointer;
    width:100%; height:100%;
    background:#1d4ed8; /* blue tiles */
  }

  /* ===== UK HUB BUTTONS ===== */
  .hub {
    display: grid;
    grid-template-rows: repeat(5, 1fr);
    grid-template-columns: 1fr;
    gap: 16px;
    height: calc(100vh - 150px);
    margin-top: 20px;
  }
  .hub .bigbtn {
    width: 100%;
    height: 100%;
    font-size: 26px;
    font-weight: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 14px;
    border: 0;
    background: #1d4ed8;
    color: #fff;
    cursor: pointer;
  }

  /* ===== BOTTOM BAR TABS ===== */
  .bottom-tabs{
    position:fixed; left:0; right:0; bottom:0;
    background:#0f131a; border-top:1px solid var(--border);
    display:flex; z-index:30;
  }
  .bottom-tabs .tab{
    flex:1; padding:12px 8px; border:0; background:transparent; color:#cfd7ea;
    font-weight:700; cursor:pointer;
  }
  .bottom-tabs .tab.active{ color:var(--brand); }
  #tab_home.active{ color:#8A2BE2; }

  /* ===== FLOATING BACK BUTTON ===== */
  .backbtn{
    position:fixed; top:14px; left:14px; z-index:50;
    background:#182034; color:#eef1f5; border:1px solid #223049;
    padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; display:none;
  }
  .backbtn:active{ transform: translateY(1px); }

  /* ===== SIZE FINDER — APP STYLE ===== */
  .sf-hero {
    background: linear-gradient(180deg, #2b1055 0%, #231048 100%);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 18px;
    padding: 22px 18px;
    margin-bottom: 16px;
  }
  .sf-hero .sf-title { margin: 0 0 6px; font-size: 26px; font-weight: 900; }
  .sf-hero .sf-sub   { margin: 0; color: #c9b7ff; font-size: 14px; }

  .sf-fields { display: grid; grid-template-columns: 1fr; gap: 12px; }
  @media (min-width: 760px) { .sf-fields { grid-template-columns: repeat(2, 1fr); } }
  @media (min-width: 1100px){ .sf-fields { grid-template-columns: repeat(4, 1fr); } }

  .sf-field { background: #151535; border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 10px; }
  .sf-label { display:block; font-size: 12px; color: #a7b1ff; margin-bottom: 6px; letter-spacing:.2px; text-transform: uppercase; }
  .sf-select, .sf-input {
    width: 100%; padding: 12px 12px; border-radius: 10px;
    border: 1px solid #2a2f57; background: #0f1330; color: #eef1f5; font-weight: 600;
    appearance: none; -webkit-appearance: none;
  }

  .sf-actions { display: flex; gap: 10px; margin-top: 12px; }
  .sf-primary {
    flex: 1; background: #1d4ed8; color: #fff; border: 0;
    padding: 14px 16px; border-radius: 14px; font-weight: 900; font-size: 16px; cursor: pointer;
  }
  .sf-secondary {
    background: transparent; color: #cfe0ff; border: 1px solid rgba(255,255,255,.12);
    padding: 14px 16px; border-radius: 14px; font-weight: 700; cursor: pointer;
  }

  .sf-result { margin-top: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,.08); background: #121433; padding: 16px; }
  .sf-result .sf-size {
    display:inline-block; font-size: 28px; font-weight: 900; padding: 8px 14px;
    border-radius: 999px; background: #1d4ed8; color: #fff;
  }
  .sf-badges { display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }
  .sf-badge  { display:inline-block; padding: 6px 10px; border-radius: 999px;
               border: 1px solid rgba(255,255,255,.12); background:#1a1d3f; color:#c9d3ea; font-size:12px; }
  .sf-note { color:#c9d3ea; font-size:14px; margin-top:8px; }
    
    /* ===== SHARED PANEL STYLE (reusing sf look) ===== */
.panel-hero{
  background: linear-gradient(180deg, #2b1055 0%, #231048 100%);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 18px; padding: 22px 18px; margin-bottom: 16px;
}
.panel-hero .title{ margin:0 0 6px; font-size:26px; font-weight:900; }
.panel-hero .sub{ margin:0; color:#c9b7ff; font-size:14px; }

.panel{ border-radius:16px; border:1px solid rgba(255,255,255,.08); background:#121433; padding:16px; }
.panel-list{ display:flex; flex-direction:column; gap:12px; }

/* ===== My Sizes ===== */
.ms-filters{
  display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:12px;
}
@media (min-width:760px){ .ms-filters{ grid-template-columns:1fr 1fr; } }
.ms-field{ background:#151535; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; }
.ms-label{ display:block; font-size:12px; color:#a7b1ff; margin-bottom:6px; letter-spacing:.2px; text-transform:uppercase; }
.ms-select{ width:100%; padding:12px; border-radius:10px; border:1px solid #2a2f57; background:#0f1330; color:#eef1f5; font-weight:600; appearance:none; -webkit-appearance:none; }
.ms-actions{ display:flex; gap:10px; margin-top:6px; }
.ms-secondary{ background:transparent; color:#cfe0ff; border:1px solid rgba(255,255,255,.12); padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer; }
.ms-item{
  display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
  border:1px solid rgba(255,255,255,.08); background:#1a1d3f; border-radius:14px; padding:12px;
}
.ms-item .meta{ color:#c9d3ea; font-size:13px; }
.ms-size{ display:inline-block; padding:6px 12px; border-radius:999px; background:#1d4ed8; color:#fff; font-weight:800; }
.badge{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:#151a3a; color:#c9d3ea; font-size:12px; }
.badge.success{ color:#8ee0b2; } .badge.warning{ color:#ffd27a; } .badge.danger{ color:#ff9a9a; }

/* ===== Brand Notes ===== */
.bn-item{
  display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
  border:1px solid rgba(255,255,255,.08); background:#1a1d3f; border-radius:14px; padding:12px;
}
.bn-name{ font-weight:800; }
.bn-pills{ display:flex; gap:6px; flex-wrap:wrap; }

/* ===== History ===== */
.hi-item{
  border:1px solid rgba(255,255,255,.08); background:#1a1d3f; border-radius:14px; padding:12px;
  display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
}
.hi-when{ color:#aab3c5; font-size:12px; }
/* ===== Body profile pill panel ===== */
.pt-pills{ display:flex; gap:8px; flex-wrap:wrap; }
.pt-pill{
  border:1px solid rgba(255,255,255,.12);
  background:#151a3a;
  color:#c9d3ea;
  font-weight:700;
  font-size:12px;
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
}
.pt-pill.active{ background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
  </style>
</head>
<body>

  <!-- ========== FLOATING BACK BUTTON ========== -->
  <button class="backbtn" id="backbtn" onclick="goBack()" aria-label="Back">◀ Back</button>

  <!-- ========== SCREENS ========== -->
  <!-- ===== SPLASH ===== -->
  <section id="splash" class="screen active">
    <div class="splash-stage">
      <div class="flash-logo-wrap" aria-label="MiSize logo">
        <div class="flash-logo-shine"></div>
      </div>
    </div>
  </section>

  <!-- ===== HOME ===== -->
  <section id="home" class="screen">
    <h1 class="big">Welcome to MiSize</h1>
    <p>Select your region:</p>
    <div class="tiles">
      <button class="uk" onclick="switchTab('uk')">UK</button>
      <button class="eu" onclick="switchTab('eu')">EU</button>
      <button class="us" onclick="switchTab('us')">US</button>
      <button class="ca" onclick="switchTab('ca')">CA</button>
    </div>
  </section>

  <!-- ===== UK (HUB) ===== -->
  <section id="uk" class="screen">
    <h2 class="big">UK</h2>
    <p class="note">Pick a tool below. Back button will appear on the next screen.</p>
    <div class="hub">
      <button class="bigbtn" onclick="openUK('uk_sizefinder')">Size Finder</button>
      <button class="bigbtn" onclick="openUK('uk_mysizes')">My Sizes (all brands)</button>
      <button class="bigbtn" onclick="openUK('uk_brandnotes')">Brand Notes</button>
      <button class="bigbtn" onclick="openUK('uk_history')">History</button>
      <button class="bigbtn" onclick="openUK('uk_converters')">Converters</button>
    </div>
  </section>

  <!-- ===== UK › SIZE FINDER (new sf- markup) ===== -->
  <section id="uk_sizefinder" class="screen">
    <div class="sf-hero">
      <h3 class="sf-title">Size Finder</h3>
      <p class="sf-sub">Pick a brand, category, fit and body type.</p>

      <div class="sf-fields">
        <div class="sf-field">
          <label class="sf-label">Brand</label>
          <select id="sf_brand" class="sf-select"></select>
        </div>

        <div class="sf-field">
          <label class="sf-label">Category</label>
          <select id="sf_category" class="sf-select"></select>
        </div>

        <div class="sf-field">
          <label class="sf-label">Fit preference</label>
          <select id="sf_fit" class="sf-select">
            <option value="standard">Standard</option>
            <option value="snug">Snug</option>
            <option value="relaxed">Relaxed</option>
          </select>
        </div>

        <div class="sf-field">
          <label class="sf-label">Body type</label>
          <select id="sf_bodytype" class="sf-select">
            <option value="standard">Standard</option>
            <option value="petite">Petite</option>
            <option value="tall">Tall</option>
            <option value="curvy">Curvy</option>
          </select>
        </div>
      </div>

      <div class="sf-actions">
        <button class="sf-primary" onclick="computeSize()">Get my size</button>
        <button class="sf-secondary" onclick="saveHistory()">Save to history</button>
      </div>
    </div>

    <!-- Result panel -->
    <div id="sf_result" class="sf-result" style="display:none;"></div>
  </section>

  <!-- ===== UK › MY SIZES ===== -->
 <!-- ===== UK › MY SIZES ===== -->
<section id="uk_mysizes" class="screen">
  <div class="panel-hero">
    <h3 class="title">My Sizes (all brands)</h3>
    <p class="sub">Select categories and a fit, then compute across all brands.</p>
  </div>

  <div class="panel">
    <div class="ms-filters">
      <div class="ms-field">
        <label class="ms-label">Categories</label>
        <select id="ms_category" class="ms-select" multiple size="4" style="height:110px;"></select>
        <p class="note" style="margin:6px 0 0;">Tip: Cmd/Ctrl-click to multi-select.</p>
      </div>
      <div class="ms-field">
        <label class="ms-label">Fit preference</label>
        <select id="ms_fit" class="ms-select">
          <option value="standard">Standard</option>
          <option value="snug">Snug</option>
          <option value="relaxed">Relaxed</option>
        </select>
        <div class="ms-actions">
          <button class="sf-primary" onclick="computeAllSizes()">Compute all</button>
          <button class="ms-secondary" onclick="exportMySizesCSV()">Export CSV</button>
          <button class="ms-secondary" onclick="copyMySizes()">Copy</button>
          <span class="badge" id="ms_count">—</span>
        </div>
      </div>
    </div>

    <div id="ms_list" class="panel-list"></div>
  </div>
</section>

  <!-- ===== UK › BRAND NOTES ===== -->
  <section id="uk_brandnotes" class="screen">
    <div class="card">
      <h3>Brand Notes</h3>
      <div id="brandList" class="list"></div>
    </div>
  </section>

  <!-- ===== UK › HISTORY ===== -->
  <section id="uk_history" class="screen">
    <div class="card">
      <h3>History</h3>
      <div id="histList" class="list"></div>
    </div>
  </section>

  <!-- ===== UK › CONVERTERS ===== -->
  <section id="uk_converters" class="screen">
    <div class="card">
      <h3>Clothes (UK ⇄ EU ⇄ US)</h3>
      <div class="row three">
        <div><label>From</label><select id="cw_from"><option>UK</option><option>EU</option><option>US</option></select></div>
        <div><label>To</label><select id="cw_to"><option>UK</option><option>EU</option><option>US</option></select></div>
        <div><label>Value</label><input id="cw_val" placeholder="e.g., 10"></div>
      </div>
      <div class="toolbar"><button class="ghost" onclick="convertClothing()">Convert</button><span class="pill" id="cw_out">—</span></div>
    </div>

    <div class="card">
      <h3>Shoes</h3>
      <div class="row three">
        <div><label>From</label><select id="sh_from"><option>UK</option><option>EU</option><option>US</option></select></div>
        <div><label>To</label><select id="sh_to"><option>UK</option><option>EU</option><option>US</option></select></div>
        <div><label>Value</label><input id="sh_val" placeholder="e.g., 5"></div>
      </div>
      <div class="toolbar"><button class="ghost" onclick="convertShoes()">Convert</button><span class="pill" id="sh_out">—</span></div>
    </div>

    <div class="card">
      <h3>Bra helper</h3>
      <div class="row three">
        <div><label>Band (cm)</label><input id="br_band" placeholder="e.g., 75"></div>
        <div><label>Cup</label><input id="br_cup" placeholder="e.g., C"></div>
        <div style="display:flex;align-items:flex-end;"><button class="ghost" onclick="convertBra()">Estimate</button></div>
      </div>
      <div class="toolbar"><span class="pill" id="br_out">—</span></div>
    </div>
  </section>

  <!-- ===== Profile (placeholder) ===== -->
  <section id="profile" class="screen">
    <h2 class="big">Profile</h2>
    <p class="note">Your profile/settings will live here. (Placeholder for now.)</p>
  </section>

  <!-- ===== EU/US/CA placeholders ===== -->
  <section id="eu" class="screen"><h2 class="big">EU</h2><p class="note">Coming later.</p></section>
  <section id="us" class="screen"><h2 class="big">US</h2><p class="note">Coming later.</p></section>
  <section id="ca" class="screen"><h2 class="big">CA</h2><p class="note">Coming later.</p></section>

  <!-- ===== MiStats / Settings placeholders ===== -->
  <section id="mistats" class="screen"><h2 class="big">MiStats</h2><p class="note">Reserved for weight/measure trends.</p></section>
  <section id="settings" class="screen"><h2 class="big">Settings</h2><p class="note">Preferences go here later.</p></section>

  <!-- ========== BOTTOM BAR TABS ========== -->
  <div class="bottom-tabs">
    <button id="tab_home" class="tab active" onclick="switchTab('home')">Home</button>
    <button id="tab_profile" class="tab" onclick="switchTab('profile')">Profile</button>
    <button id="tab_mistats" class="tab" onclick="switchTab('mistats')">MiStats</button>
    <button id="tab_settings" class="tab" onclick="switchTab('settings')">Settings</button>
  </div>

  <!-- ========== SCRIPTS ========== -->
  <script>
    /* ===== Helpers ===== */
    function $(id){ return document.getElementById(id); }

    /* ===== Navigation & Back Button ===== */
    const NAV_STACK = [];
    let CURRENT_SCREEN = 'home'; // set to splash on window load below

    function switchTab(id){
      if (id !== CURRENT_SCREEN) NAV_STACK.push(CURRENT_SCREEN);
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      (document.getElementById(id) || $('home')).classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      const t = $('tab_'+id); if (t) t.classList.add('active');
      CURRENT_SCREEN = id;
      updateBackButton();
    }

    // Open a UK sub-screen from the UK hub
    function openUK(id){
      NAV_STACK.push('uk');
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      $(id).classList.add('active');
      CURRENT_SCREEN = id;
      if (id === 'uk_mysizes') initMySizesSelectors();
      updateBackButton();
    }

    function goBack(){
      const prev = NAV_STACK.pop() || 'home';
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      (document.getElementById(prev) || $('home')).classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      const tb = $('tab_'+prev); if (tb) tb.classList.add('active');
      CURRENT_SCREEN = prev;
      updateBackButton();
    }

    function updateBackButton(){
      const btn = document.getElementById('backbtn');
      const topLevels = ['splash','home','uk','profile','mistats','settings','eu','us','ca'];
      btn.style.display = topLevels.includes(CURRENT_SCREEN) ? 'none' : 'inline-block';
    }

    /* ===== Data (persistent) ===== */
    const DEFAULT_BRANDS = [
      { id:'primark', name:'Primark', notes:'Runs true to size.', lengths_cm:{short:72, regular:76, long:80, tall:84} },
      { id:'george',  name:'George (ASDA)', notes:'Waist generous.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'next',    name:'Next', notes:'Jeans come up slightly long.', lengths_cm:{short:70, regular:74, long:78, tall:82} },
      { id:'m_s',     name:'M&S',  notes:'Consistent across seasons.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'zara',    name:'Zara', notes:'Sizes run small.', lengths_cm:{short:70, regular:74, long:78, tall:82} },
      { id:'hm',      name:'H&M',  notes:'Tops generous, bottoms small.', lengths_cm:{short:72, regular:76, long:80, tall:84} },
      { id:'river',   name:'River Island', notes:'Trendy fits, skinny jeans.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'newlook', name:'New Look', notes:'True to size but short inseams.', lengths_cm:{short:70, regular:74, long:78, tall:82} },
      { id:'asos',    name:'ASOS', notes:'Wide range, sizing varies.', lengths_cm:{short:72, regular:76, long:80, tall:84} },
      { id:'topshop', name:'Topshop', notes:'Slim cut, runs small.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'boohoo',  name:'Boohoo', notes:'Trend-led, fits vary.', lengths_cm:{short:72, regular:76, long:80, tall:84} },
      { id:'missguided', name:'Missguided', notes:'Runs snug, size up.', lengths_cm:{short:72, regular:76, long:80, tall:84} },
      { id:'plt',     name:'PrettyLittleThing', notes:'Slim cut.', lengths_cm:{short:72, regular:76, long:80, tall:84} },
      { id:'monsoon', name:'Monsoon', notes:'Occasionwear true to size.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'dorothy', name:'Dorothy Perkins', notes:'Classic fits.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'warehouse', name:'Warehouse', notes:'Contemporary fit.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'whistles', name:'Whistles', notes:'Premium, consistent sizing.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'reiss',   name:'Reiss', notes:'Slim, tailored fit.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'gap',     name:'GAP', notes:'US sizing, generous.', lengths_cm:{short:72, regular:76, long:80, tall:84} },
      { id:'uniqlo',  name:'Uniqlo', notes:'Minimalist, runs neat.', lengths_cm:{short:70, regular:74, long:78, tall:82} },
      { id:'superdry', name:'Superdry', notes:'Small fit, size up.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'jackwills', name:'Jack Wills', notes:'Slim casual fit.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'fatface', name:'FatFace', notes:'Relaxed, true to size.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'joules',  name:'Joules', notes:'Country casuals, true fit.', lengths_cm:{short:71, regular:75, long:79, tall:83} },
      { id:'oasis',   name:'Oasis', notes:'Feminine cut, neat sizing.', lengths_cm:{short:70, regular:74, long:78, tall:82} },
      { id:'cos',     name:'COS', notes:'Oversized silhouettes.', lengths_cm:{short:72, regular:76, long:80, tall:84} },
      { id:'arabella', name:'Arabella', notes:'Boutique brand, tailored.', lengths_cm:{short:70, regular:74, long:78, tall:82} },
      { id:'frenchconnection', name:'French Connection', notes:'Runs small, tailored.', lengths_cm:{short:70, regular:74, long:78, tall:82} },
      { id:'allsaints', name:'AllSaints', notes:'Slim, edgy fit.', lengths_cm:{short:70, regular:74, long:78, tall:82} },
      { id:'tedbaker', name:'Ted Baker', notes:'Numbered sizing, true to fit.', lengths_cm:{short:70, regular:74, long:78, tall:82} }
    ];

    const DEFAULT_CHARTS = [
      // Women • Dresses
      {brandId:'primark', category:'Women • Dresses', size:'8',  bust:84, waist:66, hip:90},
      {brandId:'primark', category:'Women • Dresses', size:'10', bust:88, waist:70, hip:94},
      {brandId:'george',  category:'Women • Dresses', size:'8',  bust:85, waist:67, hip:91},
      {brandId:'george',  category:'Women • Dresses', size:'10', bust:89, waist:71, hip:95},
      {brandId:'next',    category:'Women • Dresses', size:'8',  bust:84, waist:66, hip:90},
      {brandId:'next',    category:'Women • Dresses', size:'10', bust:88, waist:70, hip:94},
      {brandId:'m_s',     category:'Women • Dresses', size:'8',  bust:85, waist:67, hip:91},
      {brandId:'m_s',     category:'Women • Dresses', size:'10', bust:89, waist:71, hip:95},

      // Women • Jeans
      {brandId:'primark', category:'Women • Jeans',   size:'8',  waist:66, hip:90},
      {brandId:'primark', category:'Women • Jeans',   size:'10', waist:70, hip:94},
      {brandId:'george',  category:'Women • Jeans',   size:'8',  waist:67, hip:91},
      {brandId:'george',  category:'Women • Jeans',   size:'10', waist:71, hip:95},
      {brandId:'next',    category:'Women • Jeans',   size:'8',  waist:66, hip:90},
      {brandId:'next',    category:'Women • Jeans',   size:'10', waist:70, hip:94},
      {brandId:'m_s',     category:'Women • Jeans',   size:'8',  waist:67, hip:91},
      {brandId:'m_s',     category:'Women • Jeans',   size:'10', waist:71, hip:95},

      // Shoes (UK)
      {brandId:'primark', category:'Shoes (UK)', size:'5', footLen:24.1},
      {brandId:'primark', category:'Shoes (UK)', size:'6', footLen:24.8},
      {brandId:'george',  category:'Shoes (UK)', size:'5', footLen:24.0},
      {brandId:'george',  category:'Shoes (UK)', size:'6', footLen:24.7},
      {brandId:'next',    category:'Shoes (UK)', size:'5', footLen:24.1},
      {brandId:'next',    category:'Shoes (UK)', size:'6', footLen:24.8},
      {brandId:'m_s',     category:'Shoes (UK)', size:'5', footLen:24.0},
      {brandId:'m_s',     category:'Shoes (UK)', size:'6', footLen:24.7}
    ];

    const DEFAULT_CATEGORIES = ['Women • Dresses','Women • Jeans','Shoes (UK)'];

    function loadAppData(){
      try{
        const saved = JSON.parse(localStorage.getItem('mSizeData') || '{}');
        window.BRANDS     = Array.isArray(saved.BRANDS) ? saved.BRANDS : DEFAULT_BRANDS.slice();
        window.CHARTS     = Array.isArray(saved.CHARTS) ? saved.CHARTS : DEFAULT_CHARTS.slice();
        window.CATEGORIES = Array.isArray(saved.CATEGORIES) ? saved.CATEGORIES : DEFAULT_CATEGORIES.slice();
      }catch(e){
        window.BRANDS = DEFAULT_BRANDS.slice();
        window.CHARTS = DEFAULT_CHARTS.slice();
        window.CATEGORIES = DEFAULT_CATEGORIES.slice();
      }
    }

    function saveAppData(){
      localStorage.setItem('mSizeData', JSON.stringify({BRANDS, CHARTS, CATEGORIES}));
    }

    function resetDataToDefaults(){
      window.BRANDS = DEFAULT_BRANDS.slice();
      window.CHARTS = DEFAULT_CHARTS.slice();
      window.CATEGORIES = DEFAULT_CATEGORIES.slice();
      saveAppData();
      initSelectors(); // refresh UI
    }

    function exportData(){ return JSON.stringify({BRANDS, CHARTS, CATEGORIES}, null, 2); }
    function importData(json){
      const obj = JSON.parse(json);
      if(obj.BRANDS && obj.CHARTS && obj.CATEGORIES){
        window.BRANDS = obj.BRANDS; window.CHARTS = obj.CHARTS; window.CATEGORIES = obj.CATEGORIES;
        saveAppData(); initSelectors();
      }
    }

    /* ===== Init dropdowns & sections ===== */
    function initSelectors(){
      const b=$('sf_brand'); if(b){ b.innerHTML=''; BRANDS.forEach(br=>{ const o=document.createElement('option'); o.value=br.id; o.textContent=br.name; b.appendChild(o); }); }
      const c=$('sf_category'); if(c){ c.innerHTML=''; CATEGORIES.forEach(cat=>{ const o=document.createElement('option'); o.value=cat; o.textContent=cat; c.appendChild(o); }); }
      const ms=$('ms_category'); if(ms){ ms.innerHTML=''; CATEGORIES.forEach(cat=>{ const o=document.createElement('option'); o.value=cat; o.textContent=cat; ms.appendChild(o); }); if(ms.options.length) ms.options[0].selected=true; }
      renderBrandNotes();
      renderHistory();
    }

    /* ===== Size Finder ===== */
    function computeSize(){
      const brandId=$('sf_brand').value, cat=$('sf_category').value, fit=$('sf_fit').value, body=$('sf_bodytype').value;

      // Demo measurements (cm)
      const meas = { bust:88, waist:70, hip:94, inseam:76, footlen:24.6 };

      const brand=BRANDS.find(b=>b.id===brandId);
      const table=CHARTS.filter(r=>r.brandId===brandId && r.category===cat)
                        .map(r=>({size:r.size,bust:r.bust??null,waist:r.waist??null,hip:r.hip??null,footLen:r.footLen??null}));

      if(!brand || table.length===0){
        showResult('—','Low','No data for this brand/category yet.',[]); return;
      }

      let dims=[]; if(cat.includes('Dresses')) dims=['bust','waist','hip'];
                   if(cat.includes('Jeans'))   dims=['waist','hip'];
                   if(cat.includes('Shoes'))   dims=['footLen'];

      const wants={}; dims.forEach(d=> wants[d]=meas[d==='footLen'?'footlen':d]);
      const used=dims.filter(d=> wants[d]!=null);
      if(!used.length){ showResult('—','Low','Please add measurements for this category.',[]); return; }

      const scored=table.map(r=>({ size:r.size, score:used.reduce((s,d)=>s+Math.abs((r[d]||0)-wants[d]),0)}))
                        .sort((a,b)=>a.score-b.score);

      let pick=scored[0]; if(!pick){ showResult('—','Low','No matching sizes found.',[]); return; }
      if(scored[1]){ const diff=scored[1].score-scored[0].score; if(fit==='relaxed' && diff<2) pick=scored[1]; }

      const avg=pick.score/used.length; let conf='Medium'; if(avg<1.2 && used.length>=2) conf='High'; if(avg>3.0) conf='Low';

      const notes=[];
      if(body==='petite') notes.push('Petite: consider shorter length options.');
      if(body==='tall')   notes.push('Tall: check brand length guide; “Tall/Long” may be best.');
      if(body==='curvy')  notes.push('Curvy: prioritize hip/waist when in between.');
      if(cat.includes('Jeans') && meas.inseam && brand?.lengths_cm){
        const len = mapInseamToLengthFromBrand(brand.lengths_cm, meas.inseam);
        const inches = (brand.lengths_cm[len]/2.54).toFixed(1);
        notes.push(`Suggested length: ${len.toUpperCase()} (~${inches}" max for this label).`);
      }
      if(brand?.notes) notes.push(`Brand note: ${brand.notes}`);

      showResult(pick.size, conf, null, notes);
    }

    // NEW: styled result renderer
    function showResult(size, conf, message, notes){
      const box = $('sf_result');
      box.style.display = 'block';

      const confClass = conf === 'High' ? 'success' : (conf === 'Low' ? 'danger' : 'warning');
      const noteBadges = (notes || []).map(n => `<span class="sf-badge">${n}</span>`).join('');

      box.innerHTML = `
        <div>
          ${size === '—'
            ? `<div class="sf-note">No result for this selection.</div>`
            : `<span class="sf-size">${size}</span>`}
          ${message ? `<p class="sf-note" style="margin-top:8px;">${message}</p>` : ''}

          <div class="sf-badges" style="margin-top:10px;">
            <span class="sf-badge">Confidence: <span class="${confClass}">${conf}</span></span>
            ${noteBadges}
          </div>
        </div>
      `;

      window.scrollTo({ top: 0, behavior: 'smooth' });

      // keep history payload consistent
      window._lastResult = {
        when: new Date().toISOString(),
        brand: $('sf_brand').value,
        category: $('sf_category').value,
        size: size,
        conf: conf
      };
    }

    function mapInseamToLengthFromBrand(lengths, cm){
      const entries=Object.entries(lengths||{}); if(!entries.length) return 'regular';
      const sorted=entries.map(([k,v])=>({k, d:Math.abs(v-cm)})).sort((a,b)=>a.d-b.d);
      return sorted[0].k;
    }

    /* ===== My Sizes (across brands) ===== */
    function scoreFor(brandId, cat, meas, fit){
      const brand=BRANDS.find(b=>b.id===brandId);
      const rows=CHARTS.filter(r=>r.brandId===brandId && r.category===cat);
      if(!brand || rows.length===0) return null;

      let dims=[]; if(cat.includes('Dresses')) dims=['bust','waist','hip'];
                   if(cat.includes('Jeans'))   dims=['waist','hip'];
                   if(cat.includes('Shoes'))   dims=['footLen'];

      const wants={}; dims.forEach(d=> wants[d]=meas[d==='footLen'?'footlen':d]);
      const used=dims.filter(d=> wants[d]!=null); if(!used.length) return {size:'—',conf:'Low',notes:['Add measurements for this category.']};

      const table=rows.map(r=>({ size:r.size,bust:r.bust??null,waist:r.waist??null,hip:r.hip??null,footLen:r.footLen??null }));
      const scored=table.map(r=>({ size:r.size, score:used.reduce((s,d)=> s+Math.abs((r[d]||0)-wants[d]),0) }))
                        .sort((a,b)=>a.score-b.score);

      let pick=scored[0]; if(!pick) return {size:'—',conf:'Low',notes:['No matching sizes found.']};
      if(scored[1]){ const diff=scored[1].score-scored[0].score; if(fit==='relaxed'&&diff<2) pick=scored[1]; }

      const avg=pick.score/used.length; let conf='Medium'; if(avg<1.2&&used.length>=2) conf='High'; if(avg>3.0) conf='Low';
      const notes=[]; if(fit==='snug') notes.push('Snug fit chosen.'); if(fit==='relaxed') notes.push('Relaxed fit chosen.');
      if(cat.includes('Jeans') && brand?.lengths_cm){ notes.push('Check length options.'); }
      return { size:pick.size, conf, notes };
    }

    function initMySizesSelectors(){
      const sel=$('ms_category'); if(!sel) return; sel.innerHTML='';
      CATEGORIES.forEach(cat=>{ const o=document.createElement('option'); o.value=cat; o.textContent=cat; sel.appendChild(o); });
      if(sel.options.length) sel.options[0].selected=true;
    }

    function computeAllSizes(){
      const meas={ bust:88, waist:70, hip:94, inseam:76, footlen:24.6 };
      const sel=$('ms_category'); const fit=$('ms_fit').value;
      const cats=Array.from(sel.selectedOptions).map(o=>o.value); const results=[];
      cats.forEach(cat=>{ BRANDS.forEach(b=>{ const res=scoreFor(b.id,cat,meas,fit); if(!res) return;
        results.push({brandId:b.id,brandName:b.name,category:cat,size:res.size,conf:res.conf,notes:res.notes||[]}); }); });
      const rank={High:0,Medium:1,Low:2};
      results.sort((a,b)=> a.category.localeCompare(b.category) || (rank[a.conf]??9)-(rank[b.conf]??9) || a.brandName.localeCompare(b.brandName));
      renderMySizes(results);
    }

    function renderMySizes(list){
  const wrap = $('ms_list'); if(!wrap) return; 
  wrap.innerHTML = '';

  // update the counter badge
  const counter = $('ms_count');
  if (counter) counter.textContent = `${list.length} results`;

  if(!list.length){
    wrap.innerHTML = '<div class="sf-note">No results — add measurements or select a category.</div>';
    return;
  }

  list.forEach(row=>{
    const confClass = row.conf==='High' ? 'success' : row.conf==='Low' ? 'danger' : 'warning';
    const notesHtml = (row.notes||[]).map(n=>`<span class="badge">${n}</span>`).join(' ');

    const div = document.createElement('div');
    div.className = 'ms-item';
    div.innerHTML = `
      <div>
        <div><strong>${row.brandName}</strong> • <span class="meta">${row.category}</span></div>
        <div class="meta" style="margin-top:6px;">${notesHtml || ''}</div>
      </div>
      <div style="text-align:right;">
        <div class="ms-size">Size: ${row.size}</div>
        <div class="meta" style="margin-top:6px;">
          <span class="badge ${confClass}">Confidence: ${row.conf}</span>
        </div>
      </div>
    `;
    wrap.appendChild(div);
  });

  window._lastMySizes = list;
}

    function copyMySizes(){
      const list=window._lastMySizes||[]; if(!list.length){ alert('Nothing to copy yet.'); return; }
      const text=list.map(r=>`${r.category} — ${r.brandName}: ${r.size} (${r.conf})`).join('\n');
      navigator.clipboard?.writeText(text).then(()=>alert('Copied sizes!'),()=>alert('Copy failed.'));
    }
    function exportMySizesCSV(){
      const list=window._lastMySizes||[]; if(!list.length){ alert('Nothing to export yet.'); return; }
      const header=['Category','Brand','Size','Confidence','Notes'];
      const rows=list.map(r=>[`"${r.category}"` ,`"${r.brandName}"`,`"${r.size}"`,`"${r.conf}"`,`"${(r.notes||[]).join('; ').replace(/"/g,'""')}"`]);
      const csv=[header.join(','),...rows.map(r=>r.join(','))].join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='my-sizes.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ===== Brand notes + History ===== */
    function renderBrandNotes(){
      const wrap=$('brandList'); if(!wrap) return; wrap.innerHTML='';
      BRANDS.forEach(b=>{
        const L=b.lengths_cm||{};
        const div=document.createElement('div'); div.className='card';
        div.innerHTML=`
          <div style="display:flex;justify-content:space-between;gap:10px;">
            <div><div><strong>${b.name}</strong></div><div class="note">${b.notes||''}</div></div>
            <div style="text-align:right;">
              <span class="pill">Short ~${L.short??'–'}cm</span>
              <span class="pill">Regular ~${L.regular??'–'}cm</span>
              <span class="pill">Long ~${L.long??'–'}cm</span>
              <span class="pill">Tall ~${L.tall??'–'}cm</span>
            </div>
          </div>`;
        wrap.appendChild(div);
      });
    }

    function getHistory(){ try{ return JSON.parse(localStorage.getItem('history')||'[]'); }catch(e){ return []; } }
    function saveHistory(){ if(!window._lastResult) return; const h=getHistory(); h.unshift(window._lastResult); localStorage.setItem('history', JSON.stringify(h.slice(0,20))); alert('Saved to history.'); }

    function renderHistory(){
      const wrap=$('histList'); if(!wrap) return; wrap.innerHTML='';
      const h=getHistory();
      if(!h.length){ wrap.innerHTML='<div class="note">No lookups yet.</div>'; return; }
      h.forEach(item=>{
        const div=document.createElement('div'); div.className='card';
        div.innerHTML=`<div><div><strong>${item.brand}</strong> • ${item.category}</div>
          <div class="note">${new Date(item.when).toLocaleString()} • Recommended size: <span class="pill">${item.size}</span> • ${item.conf} confidence</div></div>`;
        wrap.appendChild(div);
      });
    }

    /* ===== Converters (demo stubs) ===== */
    function convertClothing(){
      const from = document.getElementById('cw_from').value;
      const to   = document.getElementById('cw_to').value;
      const val  = parseFloat(document.getElementById('cw_val').value);
      const out  = document.getElementById('cw_out');
      if (isNaN(val)) { out.textContent = 'Enter a number'; return; }
      out.textContent = `${val} ${from} ≈ ${val} ${to}`;
    }

    function convertShoes(){
      const from = document.getElementById('sh_from').value;
      const to   = document.getElementById('sh_to').value;
      const val  = parseFloat(document.getElementById('sh_val').value);
      const out  = document.getElementById('sh_out');
      if (isNaN(val)) { out.textContent = 'Enter a number'; return; }
      out.textContent = `${val} ${from} ≈ ${val} ${to}`;
    }

    function convertBra(){
      const bandCm = parseFloat(document.getElementById('br_band').value);
      const cup    = (document.getElementById('br_cup').value || '').toUpperCase();
      const out    = document.getElementById('br_out');
      if (isNaN(bandCm) || !cup) { out.textContent = 'Add band & cup'; return; }
      out.textContent = `~UK ${Math.round(bandCm/2.54)}${cup}`;
    }

    /* ===== Initial UI setup ===== */
    (function start(){
      loadAppData();
      if (!window.BRANDS || window.BRANDS.length === 0) { resetDataToDefaults(); }
      initSelectors();
      updateBackButton();
    })();

    // ===== Splash flow =====
    window.addEventListener('load', () => {
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById('splash').classList.add('active');
      CURRENT_SCREEN = 'splash';
      updateBackButton();

      setTimeout(() => {
        document.getElementById('splash').classList.remove('active');
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.getElementById('home').classList.add('active');

        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        const t = document.getElementById('tab_home'); if (t) t.classList.add('active');

        CURRENT_SCREEN = 'home';
        updateBackButton();
      }, 2600);
    });
  </script>

</body>
</html>
